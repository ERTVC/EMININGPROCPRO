<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TVET PROCSTORE</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/prompt-images/inventory-icon-192.png">
    <meta name="theme-color" content="#4f46e5">
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4f46e5',      // indigo-600
              'primary-end': '#14b8a6',   // teal-500
              'secondary': '#f3f4f6',    // gray-100
              'accent': '#f59e0b',       // amber-500
              'background': '#f9fafb',    // gray-50
              'surface': '#ffffff',      // white
              'text-primary': '#1f2937', // gray-800
              'text-secondary': '#6b7280', // gray-500
            },
          },
        },
      }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Add Babel Standalone for in-browser transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "recharts": "https://esm.sh/recharts@2.12.7",
    "react/": "https://esm.sh/react@18.3.1/",
    "react-dom/": "https://esm.sh/react-dom@18.3.1/"
  }
}
</script>
    <!-- PDF Generation & Excel Parsing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
  <body class="bg-background">
    <div id="root"></div>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useContext, createContext, useEffect, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
      
      const APP_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJDSURBVHgB7Zu9TtswEMf/dIS0RLkS5QkcI3SEjJA5Qjc4BskcISMkLpA5gXxCHiA/kCeUTVpAg7S0m+2xY8e2Iq+lV/pAjsR3vDsfj/gDAAEEkDbAn8sAEEDaAD8uA0AAaQP8uAwAAGkDeHoGfr8fHx8fRkdHy2639w6Ao/kI/Hq9vFwu9w7Ao3kIvN/vDx4eHvYD0L/xCFyv17e1tXU/AP2bV2CcAIIBIIBwAAggGAACCAeAAIIBIIBwAAggGAACCAeAAIIBIIBwAAggGAACCAeAAIIBIIBwAAggGAACCAeAAIIB4LaA1+v1/v7+4eHh5na7A2QO0G0+xtfr5Xq93G63B8gcINt8nHA45Pf7YwwDAAOADaA4HHA4HHI5HDzPs453uVxeX19/gAAgVwA36Nlsvru7uzc2Nu5pXiwWn5+fv4AADwG4Qc/n8/2i0A8g0wKcxwM4DwdwHg/geADAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDg+fMWkFOB3s9p2wAAAABJRU5ErkJggg==';
      
      // Context for global state management
      const AppContext = createContext();

      // Hook to use global context
      const useAppContext = () => useContext(AppContext);

      // Local storage hook
      const useLocalStorage = (key, initialValue) => {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          } catch (error) {
            console.error(error);
          }
        };

        return [storedValue, setValue];
      };
      
      const initialData = {
        inventory: [
            { id: 1, name: "Dell Latitude 5400 Laptop", category: "Electronics", quantity: 15, unit: "Pcs", department: "ICT", type: "Asset", condition: "Good", isIGA: false },
            { id: 2, name: "Epson L3210 Projector", category: "Electronics", quantity: 8, unit: "Pcs", department: "ICT", type: "Asset", condition: "Serviceable", isIGA: false },
            { id: 3, name: "A4 Ream Paper", category: "Stationery", quantity: 50, unit: "Ream", department: "Administration", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 4, name: "Welding Machine", category: "Workshop Tools", quantity: 5, unit: "Pcs", department: "Welding", type: "Asset", condition: "Good", isIGA: true },
            { id: 5, name: "Office Chairs", category: "Furniture", quantity: 25, unit: "Pcs", department: "Administration", type: "Asset", condition: "Good", isIGA: false },
            { id: 6, name: "Cooking Oil", category: "Kitchen Supplies", quantity: 20, unit: "Litres", department: "Kitchen", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 7, name: "Whiteboard Markers (Box)", category: "Stationery", quantity: 30, unit: "Box", department: "Academics", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 8, name: "HP Compaq Desktop", category: "Electronics", quantity: 10, unit: "Pcs", department: "ICT", type: "Asset", condition: "Obsolete", isIGA: false },
            { id: 9, name: "Angle Grinder", category: "Workshop Tools", quantity: 7, unit: "Pcs", department: "Mechanical", type: "Asset", condition: "Good", isIGA: false },
            { id: 10, name: "Maize Flour", category: "Kitchen Supplies", quantity: 150, unit: "Kgs", department: "Kitchen", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 11, name: "Student Lockers", category: "Furniture", quantity: 100, unit: "Pcs", department: "Accommodation", type: "Asset", condition: "Serviceable", isIGA: false },
            { id: 12, name: "Cleaning Detergent", category: "Cleaning Supplies", quantity: 45, unit: "Litres", department: "Sanitation", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 13, name: "Network Switch 24-Port", category: "Electronics", quantity: 4, unit: "Pcs", department: "ICT", type: "Asset", condition: "Good", isIGA: false },
            { id: 14, name: "Drill Bit Set", category: "Workshop Tools", quantity: 12, unit: "Box", department: "Mechanical", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 15, name: "Fabric Rolls (IGA)", category: "IGA", quantity: 20, unit: "Rolls", department: "Tailoring", type: "Consumable", condition: "N/A", isIGA: true },
            { id: 16, name: "Sugar", category: "Kitchen Supplies", quantity: 80, unit: "Kgs", department: "Kitchen", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 17, name: "HDMI Cables", category: "Electronics", quantity: 2, unit: "Pcs", department: "ICT", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 18, name: "Executive Office Desk", category: "Furniture", quantity: 3, unit: "Pcs", department: "Administration", type: "Asset", condition: "Good", isIGA: false },
            { id: 19, name: "Ballpoint Pens (Blue)", category: "Stationery", quantity: 9, unit: "Box", department: "Main Store", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 20, name: "Old Canon Projector", category: "Electronics", quantity: 1, unit: "Pcs", department: "ICT", type: "Asset", condition: "Obsolete", isIGA: false }
        ],
        recipients: [
          { id: 1, name: 'Main Store', type: 'Department' },
          { id: 2, name: 'Kitchen', type: 'Department' },
          { id: 3, name: 'Mr. John Doe', type: 'Trainer' },
          { id: 4, name: 'Jane Smith', type: 'Trainee' },
          { id: 5, name: 'ICT Department', type: 'Department' },
          { id: 6, name: 'Mrs. Alice Williams', type: 'Trainer' },
          { id: 7, name: 'Mechanical Dept', type: 'Department' },
          { id: 8, name: 'Admin Office', type: 'Staff' },
          { id: 9, name: 'Peter Jones', type: 'Trainee' }
        ],
        issueLog: [
          { id: 1, itemId: 1, quantity: 1, recipientId: 3, itemName: "Dell Latitude 5400 Laptop", recipientName: "Mr. John Doe", dateIssued: "2024-05-10T10:00:00Z", returned: false, returnDate: "2024-08-10T10:00:00Z" },
          { id: 2, itemId: 3, quantity: 2, recipientId: 8, itemName: "A4 Ream Paper", recipientName: "Admin Office", dateIssued: "2024-05-15T11:30:00Z", returned: true, returnDate: null },
          { id: 3, itemId: 4, quantity: 1, recipientId: 7, itemName: "Welding Machine", recipientName: "Mechanical Dept", dateIssued: "2024-04-20T09:00:00Z", returned: true, dateReturned: "2024-05-20T17:00:00Z", returnDate: "2024-05-20T09:00:00Z" },
          { id: 4, itemId: 6, quantity: 10, recipientId: 2, itemName: "Cooking Oil", recipientName: "Kitchen", dateIssued: "2024-05-21T14:00:00Z", returned: true, returnDate: null },
          { id: 5, itemId: 8, quantity: 1, recipientId: 6, itemName: "HP Compaq Desktop", recipientName: "Mrs. Alice Williams", dateIssued: "2022-01-15T09:00:00Z", returned: true, dateReturned: "2024-05-01T12:00:00Z", returnDate: "2024-05-01T09:00:00Z" }
        ],
        disposalLog: [
          { id: 1, itemId: 8, recipientId: 6, method: "Donation", itemName: "HP Compaq Desktop", itemCategory: "Electronics", status: "Pending" },
          { id: 2, itemId: 20, recipientId: 5, method: "Destruction", itemName: "Old Canon Projector", itemCategory: "Electronics", status: "Approved" }
        ],
        settings: {
          institutionName: "TVET PROCSTORE",
          logo: APP_LOGO_BASE64,
        }
      };
      
      const Toast = ({ message, type, onClose }) => {
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        useEffect(() => {
          const timer = setTimeout(onClose, 3000);
          return () => clearTimeout(timer);
        }, [onClose]);

        return (
          <div className={`fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-down`}>
            {message}
          </div>
        );
      };

      const LoginPage = ({ onLogin }) => {
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');

        const handleLogin = (e) => {
          e.preventDefault();
          // Hardcoded credentials
          if (username === 'admin' && password === '123') {
            onLogin({ username, role: 'admin' });
          } else if (username === 'officer' && password === 'password') {
            onLogin({ username, role: 'officer' });
          } else {
            setError('Invalid username or password');
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
              <div className="text-center mb-8">
                <img src={APP_LOGO_BASE64} alt="Logo" className="w-24 h-24 mx-auto mb-4"/>
                <h2 className="text-2xl font-bold text-gray-800">TVET PROCSTORE Login</h2>
                <p className="text-gray-500">Sign in to manage inventory</p>
              </div>
              <form onSubmit={handleLogin}>
                {error && <p className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</p>}
                <div className="mb-4">
                  <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">
                    Username
                  </label>
                  <input
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary"
                    id="username"
                    type="text"
                    placeholder="Username"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    required
                  />
                </div>
                <div className="mb-6">
                  <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                    Password
                  </label>
                  <input
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-primary"
                    id="password"
                    type="password"
                    placeholder="******************"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                  />
                </div>
                <div className="flex items-center justify-between">
                  <button
                    className="w-full bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-all duration-300"
                    type="submit"
                  >
                    Sign In
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };


      const AppProvider = ({ children }) => {
        const [inventory, setInventory] = useLocalStorage('inventory', initialData.inventory);
        const [recipients, setRecipients] = useLocalStorage('recipients', initialData.recipients);
        const [issueLog, setIssueLog] = useLocalStorage('issueLog', initialData.issueLog);
        const [disposalLog, setDisposalLog] = useLocalStorage('disposalLog', initialData.disposalLog);
        const [settings, setSettings] = useLocalStorage('settings', initialData.settings);
        const [toast, setToast] = useState(null);
        const [user, setUser] = useLocalStorage('user', null);
        const [isOnline, setIsOnline] = useState(navigator.onLine);

        useEffect(() => {
          const handleOnline = () => setIsOnline(true);
          const handleOffline = () => setIsOnline(false);

          window.addEventListener('online', handleOnline);
          window.addEventListener('offline', handleOffline);

          return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
          };
        }, []);


        const showToast = (message, type = 'info') => {
          setToast({ message, type });
        };

        const addItem = (item) => {
          setInventory(prev => [...prev, { ...item, id: Date.now() }]);
          showToast('Item added successfully!', 'success');
        };

        const updateItem = (updatedItem) => {
          setInventory(prev => prev.map(item => item.id === updatedItem.id ? updatedItem : item));
          showToast('Item updated successfully!', 'success');
        };

        const issueItem = (issueDetails) => {
            const { itemId, quantity, recipientId } = issueDetails;
            let itemUpdated = false;
            const newInventory = inventory.map(item => {
                if (item.id === itemId) {
                    if (item.quantity >= quantity) {
                        item.quantity -= quantity;
                        itemUpdated = true;
                    }
                }
                return item;
            });

            if (itemUpdated) {
                setInventory(newInventory);
                const issuedItemInfo = inventory.find(i => i.id === itemId);
                const recipientInfo = recipients.find(r => r.id === recipientId);
                const newLog = { 
                    ...issueDetails, 
                    id: Date.now(), 
                    itemName: issuedItemInfo.name,
                    recipientName: recipientInfo.name,
                    dateIssued: new Date().toISOString(),
                    returned: issuedItemInfo.type === 'Consumable' ? true : false,
                };
                setIssueLog(prev => [newLog, ...prev]);
                showToast('Item issued successfully!', 'success');
                return true;
            } else {
                showToast('Not enough stock to issue.', 'error');
                return false;
            }
        };

        const returnItem = (logId) => {
            setIssueLog(prev => prev.map(log => {
                if (log.id === logId) {
                    // Find the item in inventory to update its quantity
                    const itemToReturn = inventory.find(item => item.id === log.itemId);
                    if (itemToReturn && itemToReturn.type === 'Asset') {
                       // For assets, we don't add back to quantity. We just mark as returned.
                       // A different process would handle asset re-stocking.
                    }
                    return { ...log, returned: true, dateReturned: new Date().toISOString() };
                }
                return log;
            }));
            showToast('Asset marked as returned!', 'success');
        };
        
        const addRecipient = (recipient) => {
          setRecipients(prev => [...prev, { ...recipient, id: Date.now() }]);
          showToast('Recipient added!', 'success');
        };
        
        const updateRecipient = (updatedRecipient) => {
            setRecipients(prev => prev.map(r => r.id === updatedRecipient.id ? updatedRecipient : r));
            showToast('Recipient updated!', 'success');
        };

        const deleteRecipient = (id) => {
            setRecipients(prev => prev.filter(r => r.id !== id));
            showToast('Recipient deleted!', 'success');
        };

        const addDisposalRequest = (request) => {
          const itemToDispose = inventory.find(i => i.id === request.itemId);
          const newRequest = {
            ...request,
            id: Date.now(),
            itemName: itemToDispose.name,
            itemCategory: itemToDispose.category,
            status: 'Pending',
          };
          setDisposalLog(prev => [newRequest, ...prev]);
          updateItem({ ...itemToDispose, condition: 'Obsolete' });
          showToast('Disposal request created.', 'success');
        };

        const updateDisposalStatus = (id, status) => {
          setDisposalLog(prev => prev.map(log => log.id === id ? { ...log, status } : log));
          if (status === 'Disposed') {
              const disposalRecord = disposalLog.find(log => log.id === id);
              setInventory(prev => prev.filter(item => item.id !== disposalRecord.itemId));
          }
          showToast(`Disposal status updated to ${status}.`, 'success');
        };

        const handleLogin = (userData) => {
            setUser(userData);
        };

        const handleLogout = () => {
            setUser(null);
        };
        
        const updateSettings = (newSettings) => {
          setSettings(prev => ({ ...prev, ...newSettings }));
          showToast('Settings updated!', 'success');
        };

        const importData = (data) => {
            try {
                const parsedData = JSON.parse(data);
                if (parsedData.inventory) setInventory(parsedData.inventory);
                if (parsedData.recipients) setRecipients(parsedData.recipients);
                if (parsedData.issueLog) setIssueLog(parsedData.issueLog);
                if (parsedData.disposalLog) setDisposalLog(parsedData.disposalLog);
                if (parsedData.settings) setSettings(parsedData.settings);
                showToast('Data imported successfully!', 'success');
            } catch (error) {
                console.error("Failed to import data:", error);
                showToast('Failed to import data. Please check the file format.', 'error');
            }
        };
        
        const value = {
          inventory,
          recipients,
          issueLog,
          disposalLog,
          settings,
          user,
          isOnline,
          addItem,
          updateItem,
          issueItem,
          returnItem,
          addRecipient,
          updateRecipient,
          deleteRecipient,
          addDisposalRequest,
          updateDisposalStatus,
          showToast,
          handleLogin,
          handleLogout,
          updateSettings,
          importData,
        };

        return (
          <AppContext.Provider value={value}>
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {children}
          </AppContext.Provider>
        );
      };
      
      const StatCard = ({ icon, title, value, color }) => (
        <div className="bg-surface rounded-lg shadow p-5 flex items-center space-x-4 transition-transform transform hover:scale-105">
          <div className={`text-3xl ${color}`}>
            <i className={`fas ${icon}`}></i>
          </div>
          <div>
            <p className="text-sm text-text-secondary font-medium">{title}</p>
            <p className="text-2xl font-bold text-text-primary">{value}</p>
          </div>
        </div>
      );
      
      const Dashboard = () => {
        const { inventory, issueLog, settings } = useAppContext();

        const totalItems = useMemo(() => inventory.reduce((sum, item) => sum + item.quantity, 0), [inventory]);
        const totalIssued = useMemo(() => issueLog.length, [issueLog]);
        const lowStockItems = useMemo(() => inventory.filter(item => item.quantity < 10 && item.quantity > 0).length, [inventory]);
        const outOfStockItems = useMemo(() => inventory.filter(item => item.quantity === 0).length, [inventory]);

        const stockByCategory = useMemo(() => {
          const categories = {};
          inventory.forEach(item => {
            if (categories[item.category]) {
              categories[item.category] += item.quantity;
            } else {
              categories[item.category] = item.quantity;
            }
          });
          return Object.entries(categories).map(([name, value]) => ({ name, value }));
        }, [inventory]);

        const stockByItem = useMemo(() => {
            return inventory.slice(0, 10).map(item => ({ name: item.name, stock: item.quantity }));
        }, [inventory]);
        
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF', '#FF19AF'];

        return (
          <div className="space-y-6">
            <h1 className="text-3xl font-bold text-text-primary">Dashboard</h1>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <StatCard icon="fa-box" title="Total Items in Stock" value={totalItems} color="text-indigo-500" />
              <StatCard icon="fa-arrow-right-from-bracket" title="Total Items Issued" value={totalIssued} color="text-teal-500" />
              <StatCard icon="fa-triangle-exclamation" title="Low Stock Items" value={lowStockItems} color="text-amber-500" />
              <StatCard icon="fa-circle-xmark" title="Out of Stock" value={outOfStockItems} color="text-red-500" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div className="lg:col-span-3 bg-surface rounded-lg shadow p-5">
                    <h2 className="text-lg font-semibold text-text-primary mb-4">Stock Levels by Item (Top 10)</h2>
                    <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={stockByItem} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" angle={-20} textAnchor="end" height={60} interval={0} tick={{ fontSize: 12 }} />
                            <YAxis />
                            <Tooltip />
                            <Legend />
                            <Bar dataKey="stock" fill="#4f46e5" />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
                <div className="lg:col-span-2 bg-surface rounded-lg shadow p-5">
                    <h2 className="text-lg font-semibold text-text-primary mb-4">Stock by Category</h2>
                    <ResponsiveContainer width="100%" height={300}>
                        <PieChart>
                            <Pie
                                data={stockByCategory}
                                cx="50%"
                                cy="50%"
                                labelLine={false}
                                outerRadius={80}
                                fill="#8884d8"
                                dataKey="value"
                                nameKey="name"
                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                            >
                                {stockByCategory.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                            </Pie>
                            <Tooltip />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
            </div>
          </div>
        );
      };
      
      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center" onClick={onClose}>
            <div className="bg-surface rounded-lg shadow-xl p-6 w-full max-w-lg relative animate-fade-in-down" onClick={e => e.stopPropagation()}>
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i className="fas fa-times text-xl"></i>
              </button>
              <h2 className="text-2xl font-bold text-text-primary mb-4">{title}</h2>
              {children}
            </div>
          </div>
        );
      };
      
    const Inventory = () => {
        const { inventory, addItem, updateItem, showToast } = useAppContext();
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [isImportModalOpen, setIsImportModalOpen] = useState(false);
        const [currentItem, setCurrentItem] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [filterCategory, setFilterCategory] = useState('All');

        const categories = useMemo(() => ['All', ...new Set(inventory.map(item => item.category))], [inventory]);

        const filteredInventory = useMemo(() => {
            return inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = filterCategory === 'All' || item.category === filterCategory;
                return matchesSearch && matchesCategory;
            });
        }, [inventory, searchTerm, filterCategory]);

        const openModal = (item = null) => {
            setCurrentItem(item);
            setIsModalOpen(true);
        };

        const closeModal = () => {
            setIsModalOpen(false);
            setCurrentItem(null);
        };

        const handleSave = (itemData) => {
            if (currentItem) {
                updateItem({ ...currentItem, ...itemData });
            } else {
                addItem({ ...itemData, quantity: parseInt(itemData.quantity, 10) || 0 });
            }
            closeModal();
        };

        const handleFileImport = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        json.forEach(row => {
                            const newItem = {
                                name: row['Item Name'],
                                category: row['Category'],
                                quantity: parseInt(row['Quantity'], 10),
                                unit: row['Unit'],
                                department: row['Department'],
                                type: row['Type (Asset/Consumable)'],
                                condition: row['Condition (for Assets)'],
                                isIGA: row['Is IGA (Yes/No)']?.toLowerCase() === 'yes'
                            };
                            // Basic validation
                            if (newItem.name && newItem.category && !isNaN(newItem.quantity)) {
                                addItem(newItem);
                            }
                        });
                        showToast('Bulk import successful!', 'success');
                        setIsImportModalOpen(false);
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showToast('Error processing file. Please check format.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        };

        const downloadTemplate = () => {
            const ws = XLSX.utils.json_to_sheet([
                {
                    "Item Name": "Sample Laptop",
                    "Category": "Electronics",
                    "Quantity": 5,
                    "Unit": "Pcs",
                    "Department": "ICT",
                    "Type (Asset/Consumable)": "Asset",
                    "Condition (for Assets)": "Good",
                    "Is IGA (Yes/No)": "No"
                }
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventory Template");
            XLSX.writeFile(wb, "InventoryImportTemplate.xlsx");
        };


        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold text-text-primary">Inventory</h1>
                    <div className="flex space-x-2">
                         <button onClick={() => setIsImportModalOpen(true)} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-colors">
                            <i className="fas fa-file-import mr-2"></i>Bulk Import
                        </button>
                        <button onClick={() => openModal()} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-300">
                           <i className="fas fa-plus mr-2"></i> Add New Item
                        </button>
                    </div>
                </div>

                <div className="bg-surface rounded-lg shadow p-4 flex space-x-4">
                    <input
                        type="text"
                        placeholder="Search for items..."
                        className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                    <select
                        className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                        value={filterCategory}
                        onChange={e => setFilterCategory(e.target.value)}
                    >
                        {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                    </select>
                </div>
                
                <div className="bg-surface rounded-lg shadow overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-500">
                        <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" className="px-6 py-3">Item Name</th>
                                <th scope="col" className="px-6 py-3">Category</th>
                                <th scope="col" className="px-6 py-3">Quantity</th>
                                <th scope="col" className="px-6 py-3">Unit</th>
                                <th scope="col" className="px-6 py-3">Type</th>
                                <th scope="col" className="px-6 py-3">Condition</th>
                                <th scope="col" className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredInventory.map(item => (
                                <tr key={item.id} className="bg-white border-b hover:bg-gray-50">
                                    <th scope="row" className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{item.name}</th>
                                    <td className="px-6 py-4">{item.category}</td>
                                    <td className="px-6 py-4">{item.quantity}</td>
                                    <td className="px-6 py-4">{item.unit}</td>
                                    <td className="px-6 py-4">{item.type}</td>
                                    <td className="px-6 py-4">{item.type === 'Asset' ? item.condition : 'N/A'}</td>
                                    <td className="px-6 py-4">
                                        <button onClick={() => openModal(item)} className="font-medium text-primary hover:underline">Edit</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                     {filteredInventory.length === 0 && <p className="text-center p-4">No items found.</p>}
                </div>
                
                <InventoryFormModal isOpen={isModalOpen} onClose={closeModal} onSave={handleSave} item={currentItem} />

                <Modal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} title="Bulk Import Items">
                    <div className="space-y-4">
                        <p className="text-text-secondary">Import items from an Excel file (.xlsx). Please use the provided template to ensure correct formatting.</p>
                        <button onClick={downloadTemplate} className="w-full bg-gray-200 hover:bg-gray-300 text-text-primary font-bold py-2 px-4 rounded-lg">
                            <i className="fas fa-download mr-2"></i>Download Template
                        </button>
                        <div>
                            <label className="block mb-2 text-sm font-medium text-gray-900" htmlFor="file_input">Upload file</label>
                            <input 
                                className="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" 
                                id="file_input" 
                                type="file"
                                accept=".xlsx, .xls"
                                onChange={handleFileImport}
                            />
                        </div>
                    </div>
                </Modal>
            </div>
        );
    };

    const InventoryFormModal = ({ isOpen, onClose, onSave, item }) => {
        const [formData, setFormData] = useState({});

        useEffect(() => {
            setFormData(item || {
                name: '',
                category: '',
                quantity: 0,
                unit: 'Pcs',
                department: '',
                type: 'Consumable',
                condition: 'Good',
                isIGA: false,
            });
        }, [item]);

        const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            onSave(formData);
        };
        
        return (
            <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Item' : 'Add New Item'}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" name="name" value={formData.name || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label>Category</label>
                            <input type="text" name="category" value={formData.category || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required/>
                        </div>
                        <div>
                            <label>Department</label>
                            <input type="text" name="department" value={formData.department || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" />
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label>Quantity</label>
                            <input type="number" name="quantity" value={formData.quantity || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required/>
                        </div>
                        <div>
                            <label>Unit of Measure</label>
                            <select name="unit" value={formData.unit || 'Pcs'} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option>Pcs</option>
                                <option>Kgs</option>
                                <option>Litres</option>
                                <option>Box</option>
                                <option>Ream</option>
                            </select>
                        </div>
                    </div>
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label>Item Type</label>
                            <select name="type" value={formData.type || 'Consumable'} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option value="Consumable">Consumable</option>
                                <option value="Asset">Asset</option>
                            </select>
                        </div>
                         {formData.type === 'Asset' && (
                             <div>
                                 <label>Condition</label>
                                 <select name="condition" value={formData.condition || 'Good'} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                     <option>Good</option>
                                     <option>Serviceable</option>
                                     <option>Obsolete</option>
                                 </select>
                             </div>
                         )}
                    </div>
                    <div className="flex items-center">
                        <input type="checkbox" name="isIGA" checked={formData.isIGA || false} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" />
                        <label className="ml-2 block text-sm text-gray-900">Income-Generating Activity (IGA) Item?</label>
                    </div>
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Save Item</button>
                    </div>
                </form>
            </Modal>
        );
    };
    
    const IssueLog = () => {
        const { inventory, recipients, issueLog, issueItem, returnItem, addDisposalRequest } = useAppContext();
        const [isIssueModalOpen, setIsIssueModalOpen] = useState(false);
        const [isDisposalModalOpen, setIsDisposalModalOpen] = useState(false);
        const [itemToDispose, setItemToDispose] = useState(null);

        const handleIssueSave = (issueData) => {
            const success = issueItem(issueData);
            if (success) {
                setIsIssueModalOpen(false);
            }
        };

        const handleDisposalSave = (disposalData) => {
            addDisposalRequest(disposalData);
            setIsDisposalModalOpen(false);
            setItemToDispose(null);
        };
        
        const openDisposalModal = (item) => {
          const obsoleteLog = issueLog.find(log => log.itemId === item.id && item.condition === 'Obsolete');
          if (obsoleteLog) {
            setItemToDispose({ ...item, recipientId: obsoleteLog.recipientId });
            setIsDisposalModalOpen(true);
          } else {
             // Fallback or alert if no log found - this case should be rare
             setItemToDispose({ ...item, recipientId: null });
             setIsDisposalModalOpen(true);
          }
        };

        const pendingReturns = useMemo(() => issueLog.filter(log => !log.returned), [issueLog]);

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold text-text-primary">Issue & Disposal Log</h1>
                    <button onClick={() => setIsIssueModalOpen(true)} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg shadow">
                       <i className="fas fa-plus mr-2"></i> Issue New Item
                    </button>
                </div>
                
                <div className="bg-surface rounded-lg shadow">
                    <h2 className="text-xl font-semibold p-4 border-b">Pending Asset Returns</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-500">
                             <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3">Item Name</th>
                                    <th className="px-6 py-3">Recipient</th>
                                    <th className="px-6 py-3">Date Issued</th>
                                    <th className="px-6 py-3">Expected Return Date</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {pendingReturns.map(log => (
                                     <tr key={log.id} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4">{log.itemName}</td>
                                        <td className="px-6 py-4">{log.recipientName}</td>
                                        <td className="px-6 py-4">{new Date(log.dateIssued).toLocaleDateString()}</td>
                                        <td className="px-6 py-4">{new Date(log.returnDate).toLocaleDateString()}</td>
                                        <td className="px-6 py-4">
                                            <button onClick={() => returnItem(log.id)} className="bg-green-500 hover:bg-green-600 text-white text-xs py-1 px-2 rounded">Mark as Returned</button>

                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {pendingReturns.length === 0 && <p className="text-center p-4">No pending asset returns.</p>}
                    </div>
                </div>

                <div className="bg-surface rounded-lg shadow">
                    <h2 className="text-xl font-semibold p-4 border-b">Obsolete Assets for Disposal</h2>
                    <div className="overflow-x-auto">
                         <table className="w-full text-sm text-left text-gray-500">
                             <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3">Item Name</th>
                                    <th className="px-6 py-3">Category</th>
                                    <th className="px-6 py-3">Department</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {inventory.filter(i => i.condition === 'Obsolete').map(item => (
                                     <tr key={item.id} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4">{item.name}</td>
                                        <td className="px-6 py-4">{item.category}</td>
                                        <td className="px-6 py-4">{item.department}</td>
                                        <td className="px-6 py-4">
                                            <button onClick={() => openDisposalModal(item)} className="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">Request Disposal</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {inventory.filter(i => i.condition === 'Obsolete').length === 0 && <p className="text-center p-4">No obsolete assets awaiting disposal.</p>}
                    </div>
                </div>
                
                <IssueFormModal isOpen={isIssueModalOpen} onClose={() => setIsIssueModalOpen(false)} onSave={handleIssueSave} />
                {itemToDispose && <DisposalFormModal isOpen={isDisposalModalOpen} onClose={() => { setIsDisposalModalOpen(false); setItemToDispose(null); }} onSave={handleDisposalSave} item={itemToDispose} />}
            </div>
        );
    };

    const IssueFormModal = ({ isOpen, onClose, onSave }) => {
        const { inventory, recipients } = useAppContext();
        const [itemId, setItemId] = useState('');
        const [quantity, setQuantity] = useState(1);
        const [recipientId, setRecipientId] = useState('');
        const [returnDate, setReturnDate] = useState('');
        const [error, setError] = useState('');

        const selectedItem = useMemo(() => inventory.find(i => i.id === parseInt(itemId, 10)), [itemId, inventory]);

        const handleSubmit = (e) => {
            e.preventDefault();
            setError('');

            if (!selectedItem) {
                setError('Please select an item.');
                return;
            }

            if (selectedItem.quantity < quantity) {
                setError('Not enough items in stock.');
                return;
            }

            if (selectedItem.type === 'Asset' && !returnDate) {
                setError('Please provide an expected return date for assets.');
                return;
            }

            onSave({ 
                itemId: parseInt(itemId, 10), 
                quantity: parseInt(quantity, 10), 
                recipientId: parseInt(recipientId, 10),
                returnDate: selectedItem.type === 'Asset' ? returnDate : null,
            });
            // Reset form
            setItemId('');
            setQuantity(1);
            setRecipientId('');
            setReturnDate('');
        };

        return (
            <Modal isOpen={isOpen} onClose={onClose} title="Issue Item">
                <form onSubmit={handleSubmit} className="space-y-4">
                    {error && <p className="bg-red-100 text-red-700 p-2 rounded">{error}</p>}
                    <div>
                        <label>Item</label>
                        <select value={itemId} onChange={e => setItemId(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                            <option value="">Select an item</option>
                            {inventory.map(item => <option key={item.id} value={item.id}>{item.name} (In Stock: {item.quantity})</option>)}
                        </select>
                    </div>
                    <div>
                        <label>Quantity</label>
                        <input type="number" value={quantity} onChange={e => setQuantity(e.target.value)} min="1" max={selectedItem?.quantity} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                    </div>
                    <div>
                        <label>Recipient</label>
                         <select value={recipientId} onChange={e => setRecipientId(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                            <option value="">Select a recipient</option>
                            {recipients.map(r => <option key={r.id} value={r.id}>{r.name} ({r.type})</option>)}
                        </select>
                    </div>
                    {selectedItem?.type === 'Asset' && (
                        <div>
                            <label>Expected Return Date</label>
                            <input type="date" value={returnDate} onChange={e => setReturnDate(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                        </div>
                    )}
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Issue Item</button>
                    </div>
                </form>
            </Modal>
        );
    };
    
    const DisposalFormModal = ({ isOpen, onClose, onSave, item }) => {
        const { recipients } = useAppContext();
        const [method, setMethod] = useState('Public Auction');
        
        if (!item) return null;
        
        const handleSubmit = (e) => {
            e.preventDefault();
            onSave({ itemId: item.id, recipientId: item.recipientId, method });
        };

        return (
            <Modal isOpen={isOpen} onClose={onClose} title={`Request Disposal for ${item.name}`}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <p><strong>Item:</strong> {item.name}</p>
                    <p><strong>Category:</strong> {item.category}</p>
                    <p><strong>Last Holder:</strong> {recipients.find(r => r.id === item.recipientId)?.name || 'N/A'}</p>
                     <div>
                        <label>Recommended Disposal Method</label>
                        <select value={method} onChange={e => setMethod(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option>Public Auction</option>
                            <option>Public Tender</option>
                            <option>Donation</option>
                            <option>Destruction</option>
                            <option>Trade-in</option>
                        </select>
                    </div>
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-2 px-4 rounded-lg">Submit Request</button>
                    </div>
                </form>
            </Modal>
        );
    };
    
    const RecipientsPage = () => {
        const { recipients, addRecipient, updateRecipient, deleteRecipient } = useAppContext();
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [currentItem, setCurrentItem] = useState(null);

        const openModal = (item = null) => {
            setCurrentItem(item);
            setIsModalOpen(true);
        };

        const closeModal = () => {
            setIsModalOpen(false);
            setCurrentItem(null);
        };

        const handleSave = (data) => {
            if (currentItem) {
                updateRecipient({ ...currentItem, ...data });
            } else {
                addRecipient(data);
            }
            closeModal();
        };
        
        const RecipientFormModal = ({ isOpen, onClose, onSave, item }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                setFormData(item || { name: '', type: 'Trainee' });
            }, [item]);

            const handleChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={item ? "Edit Recipient" : "Add Recipient"}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label>Name</label>
                            <input type="text" name="name" value={formData.name || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                        </div>
                        <div>
                            <label>Type</label>
                            <select name="type" value={formData.type || 'Trainee'} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option>Trainee</option>
                                <option>Trainer</option>
                                <option>Staff</option>
                                <option>Department</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div className="flex justify-end pt-4">
                            <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                            <button type="submit" className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Save</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold text-text-primary">Recipients</h1>
                    <button onClick={() => openModal()} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg shadow">
                       <i className="fas fa-plus mr-2"></i> Add New Recipient
                    </button>
                </div>
                <div className="bg-surface rounded-lg shadow overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-500">
                        <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th className="px-6 py-3">Name</th>
                                <th className="px-6 py-3">Type</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {recipients.map(r => (
                                <tr key={r.id} className="bg-white border-b hover:bg-gray-50">
                                    <td className="px-6 py-4">{r.name}</td>
                                    <td className="px-6 py-4">{r.type}</td>
                                    <td className="px-6 py-4 space-x-4">
                                        <button onClick={() => openModal(r)} className="font-medium text-primary hover:underline">Edit</button>
                                        <button onClick={() => deleteRecipient(r.id)} className="font-medium text-red-600 hover:underline">Delete</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <RecipientFormModal isOpen={isModalOpen} onClose={closeModal} onSave={handleSave} item={currentItem} />
            </div>
        );
    };

    const Reports = () => {
        const { inventory, issueLog, disposalLog, settings } = useAppContext();
        const { jsPDF } = window.jspdf;

        const generatePdf = (title, head, body) => {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // Add Logo
            if (settings.logo) {
                try {
                    doc.addImage(settings.logo, 'PNG', 15, 10, 30, 30);
                } catch(e) { console.error("Error adding logo to PDF", e); }
            }

            // Add Header
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(settings.institutionName || "Inventory Report", pageWidth / 2, 25, { align: 'center' });
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(title, pageWidth / 2, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth - 15, 20, { align: 'right' });


            doc.autoTable({
                head: [head],
                body: body,
                startY: 50,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] }, // primary color
            });
            
            // Add Footer
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text('Page ' + String(i) + ' of ' + String(pageCount), pageWidth - 15, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
            }

            doc.save(`${title.replace(/ /g, '_')}.pdf`);
        };

        const generateFullStockReport = () => {
            const head = ['Name', 'Category', 'Quantity', 'Unit', 'Type', 'Condition'];
            const body = inventory.map(i => [i.name, i.category, i.quantity, i.unit, i.type, i.type === 'Asset' ? i.condition : 'N/A']);
            generatePdf('Full Stock Report', head, body);
        };
        
        const generateAssetReport = () => {
            const head = ['Name', 'Category', 'Quantity', 'Department', 'Condition'];
            const body = inventory.filter(i => i.type === 'Asset').map(i => [i.name, i.category, i.quantity, i.department, i.condition]);
            generatePdf('Asset Inventory Report', head, body);
        };
        
        const generateDepartmentReport = (department) => {
             const head = ['Name', 'Category', 'Quantity', 'Unit', 'Type'];
             const body = inventory.filter(i => i.department === department).map(i => [i.name, i.category, i.quantity, i.unit, i.type]);
             generatePdf(`${department} Department Stock Report`, head, body);
        };
        
        const generateKitchenReport = () => {
             const head = ['Name', 'Category', 'Quantity', 'Unit'];
             const body = inventory.filter(i => i.department === 'Kitchen' || i.category.toLowerCase().includes('food')).map(i => [i.name, i.category, i.quantity, i.unit]);
             generatePdf(`Kitchen Inventory Report`, head, body);
        };
        
        const generateIGAReport = () => {
            const head = ['Name', 'Category', 'Quantity', 'Unit'];
            const body = inventory.filter(i => i.isIGA).map(i => [i.name, i.category, i.quantity, i.unit]);
            generatePdf('IGA Stock Report', head, body);
        };

        const generateDisposalForm = (log) => {
            const doc = new jsPDF();
            // This is a simplified version of an official form (e.g., SP/DISP/1)
            const pageWidth = doc.internal.pageSize.getWidth();
            
            if (settings.logo) {
                doc.addImage(settings.logo, 'PNG', 15, 10, 20, 20);
            }
            doc.setFontSize(16);
            doc.text(settings.institutionName, pageWidth / 2, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text("ASSET DISPOSAL FORM", pageWidth / 2, 30, { align: 'center' });
            doc.setLineWidth(0.5);
            doc.line(15, 35, pageWidth - 15, 35);

            doc.autoTable({
                startY: 40,
                theme: 'plain',
                body: [
                    ['Item to be Disposed:', log.itemName],
                    ['Category:', log.itemCategory],
                    ['Date of Request:', new Date().toLocaleDateString()],
                    ['Recommended Method:', log.method],
                    ['Status:', log.status],
                    ['Reason for Disposal:', 'Marked as Obsolete'],
                ],
            });

            const finalY = doc.autoTable.previous.finalY;
            doc.text("Authorization:", 15, finalY + 15);
            doc.text("Procurement Officer: ....................................", 15, finalY + 30);
            doc.text("Date: ......................", 140, finalY + 30);
            doc.text("Head of Institution: ....................................", 15, finalY + 45);
            doc.text("Date: ......................", 140, finalY + 45);

            doc.save(`Disposal_Form_${log.itemName.replace(/ /g, '_')}.pdf`);
        };

        const uniqueDepartments = useMemo(() => [...new Set(inventory.map(i => i.department).filter(Boolean))], [inventory]);

        return (
            <div className="space-y-6">
                <h1 className="text-3xl font-bold text-text-primary">Reports</h1>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <ReportCard title="Full Stock Report" icon="fa-boxes-stacked" onClick={generateFullStockReport} />
                    <ReportCard title="Asset Report" icon="fa-computer" onClick={generateAssetReport} />
                    <ReportCard title="Kitchen Inventory" icon="fa-kitchen-set" onClick={generateKitchenReport} />
                    <ReportCard title="IGA Inventory" icon="fa-dollar-sign" onClick={generateIGAReport} />
                    {uniqueDepartments.map(dept => (
                       <ReportCard key={dept} title={`${dept} Dept. Report`} icon="fa-building" onClick={() => generateDepartmentReport(dept)} />
                    ))}
                </div>

                 <div className="bg-surface rounded-lg shadow mt-8">
                    <h2 className="text-xl font-semibold p-4 border-b">Disposal Requests Log</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-500">
                             <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3">Item Name</th>
                                    <th className="px-6 py-3">Status</th>
                                    <th className="px-6 py-3">Method</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {disposalLog.map(log => (
                                     <tr key={log.id} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4">{log.itemName}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${log.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : log.status === 'Approved' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                                                {log.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">{log.method}</td>
                                        <td className="px-6 py-4">
                                            <button onClick={() => generateDisposalForm(log)} className="font-medium text-primary hover:underline">
                                               <i className="fas fa-file-pdf mr-1"></i> Generate Form
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {disposalLog.length === 0 && <p className="text-center p-4">No disposal requests found.</p>}
                    </div>
                </div>

            </div>
        );
    };
    
    const ReportCard = ({ title, icon, onClick }) => (
        <button onClick={onClick} className="bg-surface rounded-lg shadow p-5 flex flex-col items-center justify-center space-y-3 transition-all transform hover:scale-105 hover:shadow-lg hover:bg-indigo-50">
            <div className="text-4xl text-primary">
                <i className={`fas ${icon}`}></i>
            </div>
            <p className="text-md font-semibold text-text-primary text-center">{title}</p>
        </button>
    );

    const Settings = () => {
        const { settings, updateSettings, showToast, importData } = useAppContext();
        const [institutionName, setInstitutionName] = useState(settings.institutionName);
        const [logo, setLogo] = useState(settings.logo);

        const handleSave = () => {
            updateSettings({ institutionName, logo });
        };
        
        const handleLogoUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    setLogo(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        };

        const exportData = () => {
            const data = {
                inventory: JSON.parse(localStorage.getItem('inventory')),
                recipients: JSON.parse(localStorage.getItem('recipients')),
                issueLog: JSON.parse(localStorage.getItem('issueLog')),
                disposalLog: JSON.parse(localStorage.getItem('disposalLog')),
                settings: JSON.parse(localStorage.getItem('settings')),
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tvet-procstore-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        };

        const handleDataImport = (e) => {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = (event) => {
                    importData(event.target.result);
                };
                reader.readAsText(file);
            }
        };

        return (
            <div className="space-y-6 max-w-2xl mx-auto">
                <h1 className="text-3xl font-bold text-text-primary">Settings</h1>

                <div className="bg-surface rounded-lg shadow p-6 space-y-4">
                     <div>
                        <label className="block text-sm font-medium text-gray-700">Institution Name</label>
                        <input 
                            type="text" 
                            value={institutionName}
                            onChange={(e) => setInstitutionName(e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                        />
                    </div>
                    <div>
                         <label className="block text-sm font-medium text-gray-700">Institution Logo</label>
                         <div className="mt-1 flex items-center space-x-4">
                            <img src={logo} alt="Logo Preview" className="h-16 w-16 object-contain bg-gray-100 rounded-md"/>
                             <input type="file" accept="image/*" onChange={handleLogoUpload} className="text-sm" />
                         </div>
                    </div>
                    <div className="flex justify-end pt-2">
                        <button onClick={handleSave} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">
                            Save Settings
                        </button>
                    </div>
                </div>

                <div className="bg-surface rounded-lg shadow p-6 space-y-4">
                    <h2 className="text-xl font-semibold">Data Management</h2>
                    <div className="flex space-x-4">
                        <button onClick={exportData} className="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
                           <i className="fas fa-download mr-2"></i> Export Data (Backup)
                        </button>
                         <label className="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer text-center">
                            <i className="fas fa-upload mr-2"></i> Import Data (Restore)
                            <input type="file" accept=".json" onChange={handleDataImport} className="hidden" />
                         </label>
                    </div>
                </div>
            </div>
        );
    };

      
      const Sidebar = ({ activePage, setActivePage, onLogout, user }) => {
        const { settings } = useAppContext();
        const isAdmin = user?.role === 'admin';
        
        const NavLink = ({ page, icon, children }) => (
          <li
            className={`cursor-pointer rounded-md transition-colors ${
              activePage === page ? 'bg-indigo-700' : 'hover:bg-indigo-500'
            }`}
          >
            <a onClick={() => setActivePage(page)} className="flex items-center p-3">
              <i className={`fas ${icon} w-6 text-center`}></i>
              <span className="ml-3">{children}</span>
            </a>
          </li>
        );

        return (
          <aside className="w-64 bg-gradient-to-b from-primary to-primary-end text-white flex flex-col fixed h-full shadow-lg">
            <div className="p-4 flex items-center space-x-3 border-b border-indigo-500">
                <img src={settings.logo} alt="Logo" className="w-12 h-12 rounded-full bg-white p-1"/>
                <h1 className="text-xl font-bold">{settings.institutionName}</h1>
            </div>
            <nav className="flex-1 p-4">
              <ul className="space-y-2">
                <NavLink page="dashboard" icon="fa-chart-pie">Dashboard</NavLink>
                <NavLink page="inventory" icon="fa-box">Inventory</NavLink>
                <NavLink page="issueLog" icon="fa-clipboard-list">Issue & Disposal</NavLink>
                <NavLink page="recipients" icon="fa-users">Recipients</NavLink>
                <NavLink page="reports" icon="fa-file-pdf">Reports</NavLink>
                {isAdmin && <NavLink page="settings" icon="fa-cog">Settings</NavLink>}
              </ul>
            </nav>
            <div className="p-4 border-t border-indigo-500">
               <div className="flex items-center space-x-3 mb-4">
                 <div className="w-10 h-10 rounded-full bg-indigo-200 text-primary flex items-center justify-center font-bold text-lg">
                   {user.username.charAt(0).toUpperCase()}
                 </div>
                 <div>
                   <p className="font-semibold">{user.username}</p>
                   <p className="text-xs text-indigo-200 capitalize">{user.role}</p>
                 </div>
               </div>
               <button onClick={onLogout} className="w-full text-left flex items-center p-3 rounded-md hover:bg-indigo-500 transition-colors">
                  <i className="fas fa-sign-out-alt w-6 text-center"></i>
                  <span className="ml-3">Logout</span>
               </button>
            </div>
          </aside>
        );
      };

      const App = () => {
        const { user, handleLogin, handleLogout, isOnline } = useAppContext();
        const [activePage, setActivePage] = useState('dashboard');

        if (!user) {
          return <LoginPage onLogin={handleLogin} />;
        }
        
        const renderPage = () => {
          switch (activePage) {
            case 'dashboard': return <Dashboard />;
            case 'inventory': return <Inventory />;
            case 'issueLog': return <IssueLog />;
            case 'recipients': return <RecipientsPage />;
            case 'reports': return <Reports />;
            case 'settings': return <Settings />;
            default: return <Dashboard />;
          }
        };

        return (
          <div className="flex h-screen bg-background">
            <Sidebar activePage={activePage} setActivePage={setActivePage} onLogout={handleLogout} user={user} />
            <div className="flex-1 flex flex-col ml-64">
                <header className="bg-surface shadow-sm p-4 flex justify-end items-center">
                    <div className={`flex items-center space-x-2 px-3 py-1 rounded-full text-sm ${isOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        <span className={`h-2 w-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`}></span>
                        <span>{isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                </header>
                <main className="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    <div className="max-w-7xl mx-auto">
                        {renderPage()}
                    </div>
                     <footer className="text-center p-4 text-xs text-text-secondary mt-auto">
                       {new Date().getFullYear()} TVET PROCSTORE. All rights reserved. Made with <i className="fas fa-heart text-red-500"></i> by Mr Felix.
                    </footer>
                </main>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <AppProvider>
            <App />
          </AppProvider>
        </React.StrictMode>
      );
    </script>
  </body>
</html>