<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TVET PROCSTORE</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/prompt-images/inventory-icon-192.png">
    <meta name="theme-color" content="#4f46e5">
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#4f46e5',      // indigo-600
              'primary-end': '#14b8a6',   // teal-500
              'secondary': '#f3f4f6',    // gray-100
              'accent': '#f59e0b',       // amber-500
              'background': '#f9fafb',    // gray-50
              'surface': '#ffffff',      // white
              'text-primary': '#1f2937', // gray-800
              'text-secondary': '#6b7280', // gray-500
            },
          },
        },
      }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Add Babel Standalone for in-browser transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "recharts": "https://esm.sh/recharts@2.12.7",
    "react/": "https://esm.sh/react@18.3.1/",
    "react-dom/": "https://esm.sh/react-dom@18.3.1/"
  }
}
</script>
    <!-- PDF Generation & Excel Parsing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
  <body class="bg-background">
    <div id="root"></div>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useContext, createContext, useEffect, useCallback } from 'react';
      import ReactDOM from 'react-dom/client';
      import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
      
      const APP_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAJDSURBVHgB7Zu9TtswEMf/dIS0RLkS5QkcI3SEjJA5Qjc4BskcISMkLpA5gXxCHiA/kCeUTVpAg7S0m+2xY8e2Iq+lV/pAjsR3vDsfj/gDAAEEkDbAn8sAEEDaAD8uA0AAaQP8uAwAAGkDeHoGfr8fHx8fRkdHy2639w6Ao/kI/Hq9vFwu9w7Ao3kIvN/vDx4eHvYD0L/xCFyv17e1tXU/AP2bV2CcAIIBIIBwAAggGAACCAeAAIIBIIBwAAggGAACCAeAAIIBIIBwAAggGAACCAeAAIIBIIBwAAggGAACCAeAAIIB4LaA1+v1/v7+4eHh5na7A2QO0G0+xtfr5Xq93G63B8gcINt8nHA45Pf7YwwDAAOADaA4HHA4HHI5HDzPs453uVxeX19/gAAgVwA36Nlsvru7uzc2Nu5pXiwWn5+fv4AADwG4Qc/n8/2i0A8g0wKcxwM4DwdwHg/geADAeQDgeQDAeQDgeQDAeQDgeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDgeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDAeQDg+fMWkFOB3s9p2wAAAABJRU5ErkJggg==';
      
      // Context for global state management
      const AppContext = createContext();

      // Hook to use global context
      const useAppContext = () => useContext(AppContext);

      // Local storage hook
      const useLocalStorage = (key, initialValue) => {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          } catch (error) {
            console.error(error);
          }
        };

        return [storedValue, setValue];
      };
      
      const initialData = {
        inventory: [
            // ASSETS (templates, no quantity)
            { id: 1, name: "Dell Latitude 5400 Laptop", category: "Electronics", unit: "Pcs", department: "ICT", type: "Asset", isIGA: false },
            { id: 2, name: "Epson L3210 Projector", category: "Electronics", unit: "Pcs", department: "ICT", type: "Asset", isIGA: false },
            { id: 4, name: "Welding Machine", category: "Workshop Tools", unit: "Pcs", department: "Welding", type: "Asset", isIGA: true },
            { id: 5, name: "Office Chairs", category: "Furniture", unit: "Pcs", department: "Administration", type: "Asset", isIGA: false },
            { id: 8, name: "HP Compaq Desktop", category: "Electronics", unit: "Pcs", department: "ICT", type: "Asset", isIGA: false },
            { id: 9, name: "Angle Grinder", category: "Workshop Tools", unit: "Pcs", department: "Mechanical", type: "Asset", isIGA: false },
            { id: 11, name: "Student Lockers", category: "Furniture", unit: "Pcs", department: "Accommodation", type: "Asset", isIGA: false },
            { id: 13, name: "Network Switch 24-Port", category: "Electronics", unit: "Pcs", department: "ICT", type: "Asset", isIGA: false },
            { id: 18, name: "Executive Office Desk", category: "Furniture", unit: "Pcs", department: "Administration", type: "Asset", isIGA: false },
            { id: 20, name: "Old Canon Projector", category: "Electronics", unit: "Pcs", department: "ICT", type: "Asset", isIGA: false },
            
            // CONSUMABLES (with quantity)
            { id: 3, name: "A4 Ream Paper", category: "Stationery", quantity: 50, unit: "Ream", department: "Administration", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 6, name: "Cooking Oil", category: "Kitchen Supplies", quantity: 20, unit: "Litres", department: "Kitchen", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 7, name: "Whiteboard Markers (Box)", category: "Stationery", quantity: 30, unit: "Box", department: "Academics", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 10, name: "Maize Flour", category: "Kitchen Supplies", quantity: 150, unit: "Kgs", department: "Kitchen", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 12, name: "Cleaning Detergent", category: "Cleaning Supplies", quantity: 45, unit: "Litres", department: "Sanitation", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 14, name: "Drill Bit Set", category: "Workshop Tools", quantity: 12, unit: "Box", department: "Mechanical", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 15, name: "Fabric Rolls (IGA)", category: "IGA", quantity: 20, unit: "Rolls", department: "Tailoring", type: "Consumable", condition: "N/A", isIGA: true },
            { id: 16, name: "Sugar", category: "Kitchen Supplies", quantity: 80, unit: "Kgs", department: "Kitchen", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 17, name: "HDMI Cables", category: "Electronics", quantity: 0, unit: "Pcs", department: "ICT", type: "Consumable", condition: "N/A", isIGA: false },
            { id: 19, name: "Ballpoint Pens (Blue)", category: "Stationery", quantity: 9, unit: "Box", department: "Main Store", type: "Consumable", condition: "N/A", isIGA: false },
        ],
        assets: [
            // Dell Laptops (1 issued, 14 in stock)
            ...Array.from({ length: 15 }, (_, i) => ({ id: 1000 + i, inventoryId: 1, serialNumber: `DELL-L5400-${1001 + i}`, condition: "Good", status: i === 0 ? "Issued" : "In Stock", currentHolderId: i === 0 ? 3 : null })),
            // Epson Projectors (8 in stock)
            ...Array.from({ length: 8 }, (_, i) => ({ id: 2000 + i, inventoryId: 2, serialNumber: `EPS-L3210-${2001 + i}`, condition: "Serviceable", status: "In Stock", currentHolderId: null })),
            // Welding Machine (1 returned, 4 in stock)
            ...Array.from({ length: 5 }, (_, i) => ({ id: 4000 + i, inventoryId: 4, serialNumber: `WLD-MCH-${4001 + i}`, condition: "Good", status: i === 0 ? "In Stock" : "In Stock", currentHolderId: null })), // simplified, assuming all are back in stock
            // HP Desktops (10 obsolete, 1 was returned and is now in stock but obsolete)
            ...Array.from({ length: 10 }, (_, i) => ({ id: 8000 + i, inventoryId: 8, serialNumber: `HP-DCOMP-${8001 + i}`, condition: "Obsolete", status: i === 0 ? "In Stock" : "In Stock", currentHolderId: null })),
            // Old Canon Projector (1 obsolete)
            { id: 20001, inventoryId: 20, serialNumber: 'CAN-PRO-OLD-001', condition: 'Obsolete', status: 'In Stock', currentHolderId: null }
        ],
        recipients: [
          { id: 1, name: 'Main Store', type: 'Department', regNumber: '' },
          { id: 2, name: 'Kitchen', type: 'Department', regNumber: '' },
          { id: 3, name: 'Mr. John Doe', type: 'Trainer', regNumber: 'S/056/2010' },
          { id: 4, name: 'Jane Smith', type: 'Trainee', regNumber: 'T/123/2024' },
          { id: 5, name: 'ICT Department', type: 'Department', regNumber: '' },
          { id: 6, name: 'Mrs. Alice Williams', type: 'Trainer', regNumber: 'S/089/2015' },
          { id: 7, name: 'Mechanical Dept', type: 'Department', regNumber: '' },
          { id: 8, name: 'Admin Office', type: 'Staff', regNumber: 'A/002/2018' },
          { id: 9, name: 'Peter Jones', type: 'Trainee', regNumber: 'T/128/2024' }
        ],
        issueLog: [
          { id: 1, assetId: 1000, inventoryId: 1, quantity: 1, recipientId: 3, itemName: "Dell Latitude 5400 Laptop", serialNumber: 'DELL-L5400-1001', recipientName: "Mr. John Doe", dateIssued: "2024-05-10T10:00:00Z", returned: false, returnDate: "2024-08-10T10:00:00Z" },
          { id: 2, inventoryId: 3, quantity: 2, recipientId: 8, itemName: "A4 Ream Paper", recipientName: "Admin Office", dateIssued: "2024-05-15T11:30:00Z", returned: true, returnDate: null },
        ],
        disposalLog: [
          { id: 1, assetId: 8005, inventoryId: 8, method: "Donation", itemName: "HP Compaq Desktop (HP-DCOMP-8006)", itemCategory: "Electronics", status: "Pending" },
          { id: 2, assetId: 20001, inventoryId: 20, method: "Destruction", itemName: "Old Canon Projector (CAN-PRO-OLD-001)", itemCategory: "Electronics", status: "Approved" }
        ],
        settings: {
          institutionName: "TVET PROCSTORE",
          logo: APP_LOGO_BASE64,
        }
      };
      
      const Toast = ({ message, type, onClose }) => {
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        useEffect(() => {
          const timer = setTimeout(onClose, 3000);
          return () => clearTimeout(timer);
        }, [onClose]);

        return (
          <div className={`fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-fade-in-down`}>
            {message}
          </div>
        );
      };

      const LoginPage = ({ onLogin }) => {
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');

        const handleLogin = (e) => {
          e.preventDefault();
          // Hardcoded credentials
          if (username === 'admin' && password === '123') {
            onLogin({ username, role: 'admin' });
          } else if (username === 'officer' && password === 'password') {
            onLogin({ username, role: 'officer' });
          } else {
            setError('Invalid username or password');
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
              <div className="text-center mb-8">
                <img src={APP_LOGO_BASE64} alt="Logo" className="w-24 h-24 mx-auto mb-4"/>
                <h2 className="text-2xl font-bold text-gray-800">TVET PROCSTORE Login</h2>
                <p className="text-gray-500">Sign in to manage inventory</p>
              </div>
              <form onSubmit={handleLogin}>
                {error && <p className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</p>}
                <div className="mb-4">
                  <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="username">
                    Username
                  </label>
                  <input
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-primary"
                    id="username"
                    type="text"
                    placeholder="Username"
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    required
                  />
                </div>
                <div className="mb-6">
                  <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                    Password
                  </label>
                  <input
                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-primary"
                    id="password"
                    type="password"
                    placeholder="******************"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                  />
                </div>
                <div className="flex items-center justify-between">
                  <button
                    className="w-full bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-all duration-300"
                    type="submit"
                  >
                    Sign In
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };


      const AppProvider = ({ children }) => {
        const [inventory, setInventory] = useLocalStorage('inventory', initialData.inventory);
        const [assets, setAssets] = useLocalStorage('assets', initialData.assets);
        const [recipients, setRecipients] = useLocalStorage('recipients', initialData.recipients);
        const [issueLog, setIssueLog] = useLocalStorage('issueLog', initialData.issueLog);
        const [disposalLog, setDisposalLog] = useLocalStorage('disposalLog', initialData.disposalLog);
        const [settings, setSettings] = useLocalStorage('settings', initialData.settings);
        const [toast, setToast] = useState(null);
        const [user, setUser] = useLocalStorage('user', null);
        const [isOnline, setIsOnline] = useState(navigator.onLine);

        useEffect(() => {
          const handleOnline = () => setIsOnline(true);
          const handleOffline = () => setIsOnline(false);

          window.addEventListener('online', handleOnline);
          window.addEventListener('offline', handleOffline);

          return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
          };
        }, []);


        const showToast = (message, type = 'info') => {
          setToast({ message, type });
        };

        const addItem = (item, serials = []) => {
            const newInventoryItem = { ...item, id: Date.now() };
            setInventory(prev => [...prev, newInventoryItem]);
            
            if (item.type === 'Asset' && serials.length > 0) {
                const newAssets = serials.map(sn => ({
                    id: Date.now() + Math.random(),
                    inventoryId: newInventoryItem.id,
                    serialNumber: sn,
                    condition: 'Good',
                    status: 'In Stock',
                    currentHolderId: null,
                }));
                setAssets(prev => [...prev, ...newAssets]);
            }
            showToast('Item added successfully!', 'success');
        };

        const updateItem = (updatedItem) => {
          setInventory(prev => prev.map(item => item.id === updatedItem.id ? updatedItem : item));
          showToast('Item updated successfully!', 'success');
        };
        
        const updateAsset = (updatedAsset) => {
            setAssets(prev => prev.map(asset => asset.id === updatedAsset.id ? updatedAsset : asset));
            showToast(`Asset ${updatedAsset.serialNumber} updated successfully!`, 'success');
        };

        const issueItem = (issueDetails) => {
            const { inventoryId, quantity, recipientId, assetId, returnDate } = issueDetails;
            const itemTemplate = inventory.find(i => i.id === inventoryId);
            const recipientInfo = recipients.find(r => r.id === recipientId);

            if (itemTemplate.type === 'Consumable') {
                 let itemUpdated = false;
                 const newInventory = inventory.map(item => {
                    if (item.id === inventoryId && item.quantity >= quantity) {
                        item.quantity -= quantity;
                        itemUpdated = true;
                    }
                    return item;
                });
                if (itemUpdated) {
                    setInventory(newInventory);
                    // Log consumable issue
                    setIssueLog(prev => [{...issueDetails, id: Date.now(), itemName: itemTemplate.name, recipientName: recipientInfo.name, dateIssued: new Date().toISOString(), returned: true }, ...prev]);
                    showToast('Consumable issued!', 'success');
                    return true;
                } else {
                    showToast('Not enough stock to issue.', 'error');
                    return false;
                }
            } else { // Asset
                const assetToIssue = assets.find(a => a.id === assetId);
                if (!assetToIssue || assetToIssue.status !== 'In Stock') {
                    showToast('Asset not available for issue.', 'error');
                    return false;
                }
                
                // Update asset status
                setAssets(prev => prev.map(a => a.id === assetId ? { ...a, status: 'Issued', currentHolderId: recipientId } : a));
                
                // Log asset issue
                const newLog = {
                    id: Date.now(),
                    assetId,
                    inventoryId,
                    recipientId,
                    itemName: itemTemplate.name,
                    serialNumber: assetToIssue.serialNumber,
                    recipientName: recipientInfo.name,
                    dateIssued: new Date().toISOString(),
                    returned: false,
                    returnDate,
                };
                setIssueLog(prev => [newLog, ...prev]);
                showToast(`Asset ${assetToIssue.serialNumber} issued!`, 'success');
                return true;
            }
        };

        const returnItem = (logId, newCondition) => {
            const logToUpdate = issueLog.find(log => log.id === logId);
            if (!logToUpdate || !logToUpdate.assetId) {
                showToast('Error: This log is not for a returnable asset.', 'error');
                return;
            }

            // Update issue log
            setIssueLog(prev => prev.map(log =>
                log.id === logId
                    ? { ...log, returned: true, dateReturned: new Date().toISOString() }
                    : log
            ));
            
            // Update asset status and condition
            setAssets(prev => prev.map(asset => 
                asset.id === logToUpdate.assetId
                    ? { ...asset, status: 'In Stock', currentHolderId: null, condition: newCondition }
                    : asset
            ));
            
            showToast(`Asset '${logToUpdate.serialNumber}' returned. Condition set to ${newCondition}.`, 'success');
        };
        
        const addRecipient = (recipient) => {
          setRecipients(prev => [...prev, { ...recipient, id: Date.now() }]);
          showToast('Recipient added!', 'success');
        };
        
        const updateRecipient = (updatedRecipient) => {
            setRecipients(prev => prev.map(r => r.id === updatedRecipient.id ? updatedRecipient : r));
            showToast('Recipient updated!', 'success');
        };

        const deleteRecipient = (id) => {
            setRecipients(prev => prev.filter(r => r.id !== id));
            showToast('Recipient deleted!', 'success');
        };

        const addDisposalRequest = (request) => {
            const assetToDispose = assets.find(a => a.id === request.assetId);
            const itemInfo = inventory.find(i => i.id === assetToDispose.inventoryId);
            
            const newRequest = {
                ...request,
                id: Date.now(),
                inventoryId: itemInfo.id,
                itemName: `${itemInfo.name} (${assetToDispose.serialNumber})`,
                itemCategory: itemInfo.category,
                status: 'Pending',
            };
            setDisposalLog(prev => [newRequest, ...prev]);
            showToast('Disposal request created.', 'success');
        };

        const updateDisposalStatus = (id, status) => {
          const disposalRecord = disposalLog.find(log => log.id === id);
          if (!disposalRecord) return;
          
          setDisposalLog(prev => prev.map(log => log.id === id ? { ...log, status } : log));

          if (status === 'Disposed' && disposalRecord.assetId) {
              setAssets(prev => prev.map(asset => asset.id === disposalRecord.assetId ? {...asset, status: 'Disposed'} : asset));
              showToast('Asset status marked as Disposed.', 'info');
          }
          
          showToast(`Disposal status updated to ${status}.`, 'success');
        };

        const handleLogin = (userData) => {
            setUser(userData);
        };

        const handleLogout = () => {
            setUser(null);
        };
        
        const updateSettings = (newSettings) => {
          setSettings(prev => ({ ...prev, ...newSettings }));
          showToast('Settings updated!', 'success');
        };

        const importData = (data) => {
            try {
                const parsedData = JSON.parse(data);
                if (parsedData.inventory) setInventory(parsedData.inventory);
                if (parsedData.assets) setAssets(parsedData.assets);
                if (parsedData.recipients) setRecipients(parsedData.recipients);
                if (parsedData.issueLog) setIssueLog(parsedData.issueLog);
                if (parsedData.disposalLog) setDisposalLog(parsedData.disposalLog);
                if (parsedData.settings) setSettings(parsedData.settings);
                showToast('Data imported successfully!', 'success');
            } catch (error)
 {
                console.error("Failed to import data:", error);
                showToast('Failed to import data. Please check the file format.', 'error');
            }
        };
        
        const value = {
          inventory,
          assets,
          recipients,
          issueLog,
          disposalLog,
          settings,
          user,
          isOnline,
          addItem,
          updateItem,
          updateAsset,
          issueItem,
          returnItem,
          addRecipient,
          updateRecipient,
          deleteRecipient,
          addDisposalRequest,
          updateDisposalStatus,
          showToast,
          handleLogin,
          handleLogout,
          updateSettings,
          importData,
        };

        return (
          <AppContext.Provider value={value}>
            {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
            {children}
          </AppContext.Provider>
        );
      };
      
      const StatCard = ({ icon, title, value, color }) => (
        <div className="bg-surface rounded-lg shadow p-5 flex items-center space-x-4 transition-transform transform hover:scale-105">
          <div className={`text-3xl ${color}`}>
            <i className={`fas ${icon}`}></i>
          </div>
          <div>
            <p className="text-sm text-text-secondary font-medium">{title}</p>
            <p className="text-2xl font-bold text-text-primary">{value}</p>
          </div>
        </div>
      );
      
      const Dashboard = () => {
        const { inventory, assets, issueLog } = useAppContext();

        const totalItems = useMemo(() => {
            const consumableCount = inventory
                .filter(item => item.type === 'Consumable')
                .reduce((sum, item) => sum + (item.quantity || 0), 0);
            const assetCount = assets.filter(asset => asset.status === 'In Stock').length;
            return consumableCount + assetCount;
        }, [inventory, assets]);

        const totalIssued = useMemo(() => issueLog.filter(log => !log.returned).length, [issueLog]);
        
        const lowStockItems = useMemo(() => {
            const consumableLow = inventory.filter(item => item.type === 'Consumable' && item.quantity < 10 && item.quantity > 0).length;
            // You could define low stock for assets too, e.g. if count < 3
            return consumableLow;
        }, [inventory]);

        const outOfStockItemList = useMemo(() => {
            const consumableOut = inventory.filter(item => item.type === 'Consumable' && item.quantity <= 0);

            const assetTemplates = inventory.filter(item => item.type === 'Asset');
            const inStockAssetInventoryIds = new Set(assets.filter(a => a.status === 'In Stock').map(a => a.inventoryId));
            
            const assetOut = assetTemplates.filter(item => {
                const hasAnyAssets = assets.some(a => a.inventoryId === item.id);
                return hasAnyAssets && !inStockAssetInventoryIds.has(item.id);
            });

            return [...consumableOut, ...assetOut].sort((a,b) => a.name.localeCompare(b.name));
        }, [inventory, assets]);

        const outOfStockItemsCount = outOfStockItemList.length;

        const stockByCategory = useMemo(() => {
            const categories = {};
            inventory.forEach(item => {
                if (item.type === 'Consumable') {
                    categories[item.category] = (categories[item.category] || 0) + item.quantity;
                } else { // Asset
                    const assetCount = assets.filter(a => a.inventoryId === item.id && a.status === 'In Stock').length;
                    categories[item.category] = (categories[item.category] || 0) + assetCount;
                }
            });
            return Object.entries(categories).map(([name, value]) => ({ name, value }));
        }, [inventory, assets]);

        const stockByItem = useMemo(() => {
            return inventory.slice(0, 10).map(item => {
                const stock = item.type === 'Asset'
                    ? assets.filter(a => a.inventoryId === item.id && a.status === 'In Stock').length
                    : item.quantity;
                return { name: item.name, stock };
            });
        }, [inventory, assets]);
        
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF', '#FF19AF'];

        return (
          <div className="space-y-6">
            <h1 className="text-3xl font-bold text-text-primary">Dashboard</h1>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
              <StatCard icon="fa-box" title="Total Items in Stock" value={totalItems} color="text-indigo-500" />
              <StatCard icon="fa-arrow-right-from-bracket" title="Total Items Issued" value={totalIssued} color="text-teal-500" />
              <StatCard icon="fa-triangle-exclamation" title="Low Stock Items" value={lowStockItems} color="text-amber-500" />
              <StatCard icon="fa-circle-xmark" title="Out of Stock" value={outOfStockItemsCount} color="text-red-500" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div className="lg:col-span-3 bg-surface rounded-lg shadow p-5">
                    <h2 className="text-lg font-semibold text-text-primary mb-4">Stock Levels by Item (Top 10)</h2>
                    <ResponsiveContainer width="100%" height={300}>
                        <BarChart data={stockByItem} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="name" angle={-20} textAnchor="end" height={60} interval={0} tick={{ fontSize: 12 }} />
                            <YAxis />
                            <Tooltip />
                            <Legend />
                            <Bar dataKey="stock" fill="#4f46e5" />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
                <div className="lg:col-span-2 bg-surface rounded-lg shadow p-5">
                    <h2 className="text-lg font-semibold text-text-primary mb-4">Stock by Category</h2>
                    <ResponsiveContainer width="100%" height={300}>
                        <PieChart>
                            <Pie
                                data={stockByCategory}
                                cx="50%"
                                cy="50%"
                                labelLine={false}
                                outerRadius={80}
                                fill="#8884d8"
                                dataKey="value"
                                nameKey="name"
                                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                            >
                                {stockByCategory.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                            </Pie>
                            <Tooltip />
                        </PieChart>
                    </ResponsiveContainer>
                </div>
            </div>

            <div className="bg-surface rounded-lg shadow p-5">
                <h2 className="text-lg font-semibold text-text-primary mb-4">
                    <i className="fas fa-circle-xmark text-red-500 mr-2"></i>Out of Stock Items
                </h2>
                {outOfStockItemList.length > 0 ? (
                    <ul className="divide-y divide-gray-200 max-h-60 overflow-y-auto">
                    {outOfStockItemList.map(item => (
                        <li key={item.id} className="py-3 flex justify-between items-center">
                        <div>
                            <p className="font-medium text-text-primary">{item.name}</p>
                            <p className="text-sm text-text-secondary">{item.category}</p>
                        </div>
                        <span className="text-xs font-semibold text-red-600 bg-red-100 px-2 py-1 rounded-full">{item.type}</span>
                        </li>
                    ))}
                    </ul>
                ) : (
                    <p className="text-text-secondary">No items are currently out of stock. Well done!</p>
                )}
            </div>
          </div>
        );
      };
      
      const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center" onClick={onClose}>
            <div className={`bg-surface rounded-lg shadow-xl p-6 w-full ${maxWidth} relative animate-fade-in-down`} onClick={e => e.stopPropagation()}>
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i className="fas fa-times text-xl"></i>
              </button>
              <h2 className="text-2xl font-bold text-text-primary mb-4">{title}</h2>
              {children}
            </div>
          </div>
        );
      };
      
    const Inventory = () => {
        const { inventory, assets, addItem, updateItem, updateAsset, showToast } = useAppContext();
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [isImportModalOpen, setIsImportModalOpen] = useState(false);
        const [currentItem, setCurrentItem] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [filterCategory, setFilterCategory] = useState('All');
        const [expandedGroups, setExpandedGroups] = useState({});
        const [expandedItems, setExpandedItems] = useState({});
        const [editingAsset, setEditingAsset] = useState(null);

        const categories = useMemo(() => ['All', ...new Set(inventory.map(item => item.category))].sort(), [inventory]);

        const filteredInventory = useMemo(() => {
            return inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = filterCategory === 'All' || item.category === filterCategory;
                return matchesSearch && matchesCategory;
            });
        }, [inventory, searchTerm, filterCategory]);
        
        const groupedInventory = useMemo(() => {
            return filteredInventory.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                (acc[category] = acc[category] || []).push(item);
                return acc;
            }, {});
        }, [filteredInventory]);
        
        const toggleGroup = (category) => setExpandedGroups(prev => ({...prev, [category]: !prev[category]}));
        const toggleItem = (itemId) => setExpandedItems(prev => ({ ...prev, [itemId]: !prev[itemId] }));

        const openModal = (item = null) => {
            setCurrentItem(item);
            setIsModalOpen(true);
        };

        const closeModal = () => {
            setIsModalOpen(false);
            setCurrentItem(null);
        };

        const handleSave = (itemData, serials) => {
            if (currentItem) {
                updateItem({ ...currentItem, ...itemData });
            } else {
                if(itemData.type === 'Asset') {
                    addItem(itemData, serials);
                } else {
                    addItem({ ...itemData, quantity: parseInt(itemData.quantity, 10) || 0 });
                }
            }
            closeModal();
        };

        const handleFileImport = (e) => {
            // This needs updates to support serial numbers for assets.
            // For now, it will only correctly import consumables.
            showToast('Bulk import for assets is not yet supported.', 'info');
        };

        const downloadTemplate = () => {
            const ws = XLSX.utils.json_to_sheet([
                {
                    "Item Name": "Sample Consumable", "Category": "Stationery", "Quantity": 20,
                    "Unit": "Box", "Department": "Academics", "Type (Asset/Consumable)": "Consumable",
                    "Condition (for Assets)": "N/A", "Is IGA (Yes/No)": "No"
                }
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventory Template");
            XLSX.writeFile(wb, "InventoryImportTemplate.xlsx");
        };

        const handleAssetUpdate = (updatedData) => {
            updateAsset({ ...editingAsset, ...updatedData });
            setEditingAsset(null);
        };
        
        const AssetEditModal = ({ asset, onSave, onCancel }) => {
            const [condition, setCondition] = useState(asset.condition);
            const [serialNumber, setSerialNumber] = useState(asset.serialNumber);
            
            return (
                <Modal isOpen={true} onClose={onCancel} title={`Edit Asset: ${asset.serialNumber}`}>
                    <form onSubmit={(e) => { e.preventDefault(); onSave({ condition, serialNumber }); }} className="space-y-4">
                        <div>
                            <label>Serial Number</label>
                            <input type="text" value={serialNumber} onChange={e => setSerialNumber(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"/>
                        </div>
                        <div>
                             <label>Condition</label>
                             <select value={condition} onChange={e => setCondition(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                 <option>Good</option>
                                 <option>Serviceable</option>
                                 <option>Obsolete</option>
                             </select>
                         </div>
                         <div className="flex justify-end pt-4">
                            <button type="button" onClick={onCancel} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                            <button type="submit" className="bg-gradient-to-r from-primary to-primary-end text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        return (
            <div className="space-y-6">
                {editingAsset && <AssetEditModal asset={editingAsset} onSave={handleAssetUpdate} onCancel={() => setEditingAsset(null)} />}
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold text-text-primary">Inventory</h1>
                    <div className="flex space-x-2">
                         <button onClick={() => setIsImportModalOpen(true)} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow transition-colors">
                            <i className="fas fa-file-import mr-2"></i>Bulk Import
                        </button>
                        <button onClick={() => openModal()} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-300">
                           <i className="fas fa-plus mr-2"></i> Add New Item
                        </button>
                    </div>
                </div>

                <div className="bg-surface rounded-lg shadow p-4 flex space-x-4">
                    <input type="text" placeholder="Search for items..." className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                    <select className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" value={filterCategory} onChange={e => setFilterCategory(e.target.value)}>
                        {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                    </select>
                </div>
                
                 <div className="space-y-4">
                    {Object.keys(groupedInventory).sort().map(category => (
                        <div key={category} className="bg-surface rounded-lg shadow transition-all duration-300">
                            <button onClick={() => toggleGroup(category)} className="w-full text-left p-4 flex justify-between items-center" aria-expanded={!!expandedGroups[category]}>
                                <span className="font-bold text-lg text-text-primary">{category} ({groupedInventory[category].length} items)</span>
                                <i className={`fas fa-chevron-down transition-transform duration-200 ${expandedGroups[category] ? 'rotate-180' : ''}`}></i>
                            </button>
                            {expandedGroups[category] && (
                                <div className="overflow-x-auto border-t">
                                    <table className="w-full text-sm text-left text-gray-500">
                                        <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3">Item Name</th>
                                                <th className="px-6 py-3">In Stock</th>
                                                <th className="px-6 py-3">Unit</th>
                                                <th className="px-6 py-3">Type</th>
                                                <th className="px-6 py-3">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {groupedInventory[category].map(item => {
                                                const inStockCount = item.type === 'Asset' ? assets.filter(a => a.inventoryId === item.id && a.status === 'In Stock').length : item.quantity;
                                                return (
                                                <React.Fragment key={item.id}>
                                                    <tr className="bg-white border-b hover:bg-gray-50">
                                                        <th className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{item.name}</th>
                                                        <td className="px-6 py-4">{inStockCount}</td>
                                                        <td className="px-6 py-4">{item.unit}</td>
                                                        <td className="px-6 py-4">{item.type}</td>
                                                        <td className="px-6 py-4 space-x-4">
                                                            <button onClick={() => openModal(item)} className="font-medium text-primary hover:underline">Edit</button>
                                                            {item.type === 'Asset' && <button onClick={() => toggleItem(item.id)} className="font-medium text-teal-600 hover:underline">View Serials</button>}
                                                        </td>
                                                    </tr>
                                                    {expandedItems[item.id] && item.type === 'Asset' && (
                                                        <tr>
                                                            <td colSpan="5" className="p-4 bg-gray-50">
                                                                <h4 className="font-bold mb-2">Individual Assets for: {item.name}</h4>
                                                                <table className="w-full text-sm">
                                                                    <thead className="bg-gray-200">
                                                                        <tr>
                                                                            <th className="px-4 py-2 text-left">Serial Number</th>
                                                                            <th className="px-4 py-2 text-left">Condition</th>
                                                                            <th className="px-4 py-2 text-left">Status</th>
                                                                            <th className="px-4 py-2 text-left">Actions</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                    {assets.filter(a => a.inventoryId === item.id).map(asset => (
                                                                        <tr key={asset.id} className="border-b">
                                                                            <td className="px-4 py-2">{asset.serialNumber}</td>
                                                                            <td className="px-4 py-2">{asset.condition}</td>
                                                                            <td className="px-4 py-2">{asset.status}</td>
                                                                            <td className="px-4 py-2">
                                                                                <button onClick={() => setEditingAsset(asset)} className="font-medium text-primary hover:underline text-xs">Edit</button>
                                                                            </td>
                                                                        </tr>
                                                                    ))}
                                                                    </tbody>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            )})}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    ))}
                    {filteredInventory.length === 0 && (
                        <div className="bg-surface rounded-lg shadow p-6 text-center text-text-secondary">
                            <p>No items found matching your criteria.</p>
                        </div>
                    )}
                </div>
                
                <InventoryFormModal isOpen={isModalOpen} onClose={closeModal} onSave={handleSave} item={currentItem} />

                <Modal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} title="Bulk Import Items">
                    <div className="space-y-4">
                        <p className="text-text-secondary">Import items from an Excel file (.xlsx). Please use the provided template to ensure correct formatting. Note: Only consumables can be imported for now.</p>
                        <button onClick={downloadTemplate} className="w-full bg-gray-200 hover:bg-gray-300 text-text-primary font-bold py-2 px-4 rounded-lg">
                            <i className="fas fa-download mr-2"></i>Download Template
                        </button>
                        <div>
                            <label className="block mb-2 text-sm font-medium text-gray-900" htmlFor="file_input">Upload file</label>
                            <input className="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" id="file_input" type="file" accept=".xlsx, .xls" onChange={handleFileImport} />
                        </div>
                    </div>
                </Modal>
            </div>
        );
    };

    const InventoryFormModal = ({ isOpen, onClose, onSave, item }) => {
        const [formData, setFormData] = useState({});
        const [serials, setSerials] = useState('');

        useEffect(() => {
            const initialData = item || {
                name: '', category: '', quantity: 0, unit: 'Pcs',
                department: '', type: 'Consumable', isIGA: false,
            };
            setFormData(initialData);
            setSerials('');
        }, [item]);

        const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
        };

        const handleSubmit = (e) => {
            e.preventDefault();
            const serialList = serials.split('\n').map(s => s.trim()).filter(Boolean);
            if (formData.type === 'Asset' && !item && serialList.length === 0) {
                alert('Please enter at least one serial number for assets.');
                return;
            }
            onSave(formData, serialList);
        };
        
        return (
            <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Item' : 'Add New Item'}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Item Name</label>
                        <input type="text" name="name" value={formData.name || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label>Category</label><input type="text" name="category" value={formData.category || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required/></div>
                        <div><label>Department</label><input type="text" name="department" value={formData.department || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" /></div>
                    </div>
                    
                    <div>
                        <label>Item Type</label>
                        <select name="type" value={formData.type || 'Consumable'} onChange={handleChange} disabled={!!item} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary disabled:bg-gray-200">
                            <option value="Consumable">Consumable</option>
                            <option value="Asset">Asset (Serialized)</option>
                        </select>
                        {!!item && <p className="text-xs text-gray-500 mt-1">Item type cannot be changed after creation.</p>}
                    </div>
                    
                    {formData.type === 'Consumable' ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label>Quantity</label><input type="number" name="quantity" value={formData.quantity || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required/></div>
                            <div><label>Unit of Measure</label><select name="unit" value={formData.unit || 'Pcs'} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"><option>Pcs</option><option>Kgs</option><option>Litres</option><option>Box</option><option>Ream</option></select></div>
                        </div>
                    ) : (
                        !item && (
                            <div>
                                <label>Serial Numbers</label>
                                <textarea name="serials" value={serials} onChange={e => setSerials(e.target.value)} rows="5" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Enter each serial number on a new line"></textarea>
                            </div>
                        )
                    )}

                    <div className="flex items-center">
                        <input type="checkbox" name="isIGA" checked={formData.isIGA || false} onChange={handleChange} className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" />
                        <label className="ml-2 block text-sm text-gray-900">Income-Generating Activity (IGA) Item?</label>
                    </div>
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Save Item</button>
                    </div>
                </form>
            </Modal>
        );
    };
    
    const IssueLogPage = () => {
        const { issueLog, recipients, returnItem } = useAppContext();
        const [isIssueModalOpen, setIsIssueModalOpen] = useState(false);
        const [isReturnModalOpen, setIsReturnModalOpen] = useState(false);
        const [itemToReturn, setItemToReturn] = useState(null);

        const [searchTerm, setSearchTerm] = useState('');
        const [filterRecipient, setFilterRecipient] = useState('All');
        const [filterStatus, setFilterStatus] = useState('All');

        const filteredLog = useMemo(() => {
            return issueLog
                .filter(log => {
                    const matchesSearch = log.itemName.toLowerCase().includes(searchTerm.toLowerCase()) || (log.serialNumber && log.serialNumber.toLowerCase().includes(searchTerm.toLowerCase()));
                    const matchesRecipient = filterRecipient === 'All' || log.recipientId === parseInt(filterRecipient, 10);
                    const matchesStatus = filterStatus === 'All' || (filterStatus === 'Issued' && !log.returned) || (filterStatus === 'Returned' && log.returned);
                    return matchesSearch && matchesRecipient && matchesStatus;
                })
                .sort((a, b) => new Date(b.dateIssued) - new Date(a.dateIssued));
        }, [issueLog, searchTerm, filterRecipient, filterStatus]);

        const openReturnModal = (log) => {
            setItemToReturn(log);
            setIsReturnModalOpen(true);
        };

        const handleReturnSave = (logId, condition) => {
            returnItem(logId, condition);
            setIsReturnModalOpen(false);
            setItemToReturn(null);
        };
        
        const statusClass = (returned) => returned ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
        const statusText = (returned) => returned ? 'Returned' : 'Issued';

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold text-text-primary">Issue Log</h1>
                    <button onClick={() => setIsIssueModalOpen(true)} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg shadow">
                       <i className="fas fa-plus mr-2"></i> Issue New Item
                    </button>
                </div>
                
                <div className="bg-surface rounded-lg shadow p-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <input type="text" placeholder="Search item or serial..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
                    <select value={filterRecipient} onChange={e => setFilterRecipient(e.target.value)} className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="All">All Recipients</option>
                        {recipients.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                    </select>
                    <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)} className="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="All">All Statuses</option>
                        <option value="Issued">Issued (Pending)</option>
                        <option value="Returned">Returned</option>
                    </select>
                </div>

                <div className="bg-surface rounded-lg shadow">
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-500">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3">Item Name / Serial</th>
                                    <th className="px-6 py-3">Recipient</th>
                                    <th className="px-6 py-3">Qty</th>
                                    <th className="px-6 py-3">Date Issued</th>
                                    <th className="px-6 py-3">Status</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredLog.map(log => (
                                    <tr key={log.id} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4 font-medium text-gray-900">
                                            {log.itemName}
                                            {log.serialNumber && <span className="block text-xs text-gray-500">{log.serialNumber}</span>}
                                        </td>
                                        <td className="px-6 py-4">{log.recipientName}</td>
                                        <td className="px-6 py-4">{log.quantity}</td>
                                        <td className="px-6 py-4">{new Date(log.dateIssued).toLocaleDateString()}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${statusClass(log.returned)}`}>
                                                {statusText(log.returned)}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">
                                            {log.assetId && !log.returned && (
                                                <button onClick={() => openReturnModal(log)} className="font-medium text-primary hover:underline">Return</button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                         {filteredLog.length === 0 && <p className="text-center p-4">No issue records found matching your criteria.</p>}
                    </div>
                </div>

                <IssueFormModal isOpen={isIssueModalOpen} onClose={() => setIsIssueModalOpen(false)} />
                {itemToReturn && <ReturnItemModal isOpen={isReturnModalOpen} onClose={() => { setIsReturnModalOpen(false); setItemToReturn(null); }} onSave={handleReturnSave} item={itemToReturn} />}
            </div>
        );
    };

    const IssueFormModal = ({ isOpen, onClose }) => {
        const { inventory, assets, recipients, issueItem } = useAppContext();
        const [inventoryId, setInventoryId] = useState('');
        const [quantity, setQuantity] = useState(1);
        const [recipientId, setRecipientId] = useState('');
        const [returnDate, setReturnDate] = useState('');
        const [assetId, setAssetId] = useState('');
        const [error, setError] = useState('');

        const selectedItem = useMemo(() => inventory.find(i => i.id === parseInt(inventoryId, 10)), [inventoryId, inventory]);
        const availableSerials = useMemo(() => {
            if (selectedItem?.type !== 'Asset') return [];
            return assets.filter(a => a.inventoryId === selectedItem.id && a.status === 'In Stock');
        }, [selectedItem, assets]);

        const handleSubmit = (e) => {
            e.preventDefault();
            setError('');
            
            if (!selectedItem) { setError('Please select an item.'); return; }
            if (!recipientId) { setError('Please select a recipient.'); return; }
            
            let issueDetails = {
                inventoryId: selectedItem.id,
                recipientId: parseInt(recipientId, 10),
            };

            if (selectedItem.type === 'Asset') {
                if (!assetId) { setError('Please select a serial number.'); return; }
                if (!returnDate) { setError('Please provide an expected return date for assets.'); return; }
                issueDetails = { ...issueDetails, assetId: parseFloat(assetId), returnDate };
            } else {
                if (selectedItem.quantity < quantity) { setError('Not enough items in stock.'); return; }
                issueDetails = { ...issueDetails, quantity: parseInt(quantity, 10) };
            }
            
            const success = issueItem(issueDetails);
            if (success) {
                // Reset form
                setInventoryId(''); setQuantity(1); setRecipientId(''); setReturnDate(''); setAssetId('');
                onClose();
            }
        };

        return (
            <Modal isOpen={isOpen} onClose={onClose} title="Issue Item">
                <form onSubmit={handleSubmit} className="space-y-4">
                    {error && <p className="bg-red-100 text-red-700 p-2 rounded">{error}</p>}
                    <div>
                        <label>Item</label>
                        <select value={inventoryId} onChange={e => { setInventoryId(e.target.value); setAssetId(''); }} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                            <option value="">Select an item</option>
                            {inventory.map(item => {
                                const stock = item.type === 'Asset' ? assets.filter(a => a.inventoryId === item.id && a.status === 'In Stock').length : item.quantity;
                                return <option key={item.id} value={item.id} disabled={stock === 0}>{item.name} (In Stock: {stock})</option>
                            })}
                        </select>
                    </div>
                    
                    {selectedItem?.type === 'Asset' ? (
                        <div>
                            <label>Serial Number</label>
                            <select value={assetId} onChange={e => setAssetId(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                                <option value="">Select a serial number</option>
                                {availableSerials.map(a => <option key={a.id} value={a.id}>{a.serialNumber}</option>)}
                            </select>
                        </div>
                    ) : (
                        <div>
                            <label>Quantity</label>
                            <input type="number" value={quantity} onChange={e => setQuantity(e.target.value)} min="1" max={selectedItem?.quantity} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                        </div>
                    )}
                    
                    <div>
                        <label>Recipient</label>
                         <select value={recipientId} onChange={e => setRecipientId(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required>
                            <option value="">Select a recipient</option>
                            {recipients.map(r => <option key={r.id} value={r.id}>{r.name} ({r.type})</option>)}
                        </select>
                    </div>
                    {selectedItem?.type === 'Asset' && (
                        <div>
                            <label>Expected Return Date</label>
                            <input type="date" value={returnDate} onChange={e => setReturnDate(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                        </div>
                    )}
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Issue Item</button>
                    </div>
                </form>
            </Modal>
        );
    };
    
    const DisposalFormModal = ({ isOpen, onClose, onSave, asset }) => {
        const { inventory } = useAppContext();
        const [method, setMethod] = useState('Public Auction');
        
        if (!asset) return null;
        const itemInfo = inventory.find(i => i.id === asset.inventoryId);
        
        const handleSubmit = (e) => {
            e.preventDefault();
            onSave({ assetId: asset.id, method });
        };

        return (
            <Modal isOpen={isOpen} onClose={onClose} title={`Request Disposal for ${itemInfo.name}`}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <p><strong>Item:</strong> {itemInfo.name}</p>
                    <p><strong>Serial Number:</strong> {asset.serialNumber}</p>
                     <div>
                        <label>Recommended Disposal Method</label>
                        <select value={method} onChange={e => setMethod(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option>Public Auction</option><option>Public Tender</option><option>Donation</option><option>Destruction</option><option>Trade-in</option>
                        </select>
                    </div>
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-2 px-4 rounded-lg">Submit Request</button>
                    </div>
                </form>
            </Modal>
        );
    };

    const ReturnItemModal = ({ isOpen, onClose, onSave, item }) => {
        const { assets } = useAppContext();
        const [condition, setCondition] = useState('Good');

        useEffect(() => {
            if (item) {
                const currentAsset = assets.find(a => a.id === item.assetId);
                setCondition(currentAsset?.condition || 'Good');
            }
        }, [item, assets]);

        if (!item) return null;

        const handleSubmit = (e) => {
            e.preventDefault();
            onSave(item.id, condition);
        };

        return (
            <Modal isOpen={isOpen} onClose={onClose} title={`Return: ${item.itemName} (${item.serialNumber})`}>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <p><strong>Recipient:</strong> {item.recipientName}</p>
                    <p><strong>Date Issued:</strong> {new Date(item.dateIssued).toLocaleDateString()}</p>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Condition on Return</label>
                        <select value={condition} onChange={e => setCondition(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                            <option>Good</option><option>Serviceable</option><option>Obsolete</option>
                        </select>
                        <p className="mt-1 text-xs text-gray-500">Please assess the item and select its current condition.</p>
                    </div>
                    <div className="flex justify-end pt-4">
                        <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                        <button type="submit" className="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-2 px-4 rounded-lg">Confirm Return</button>
                    </div>
                </form>
            </Modal>
        );
    };
    
    const ClearancePage = () => {
        const { recipients, issueLog, settings } = useAppContext();
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedRecipient, setSelectedRecipient] = useState(null);
        const [recipientHistory, setRecipientHistory] = useState([]);
        const { jsPDF } = window.jspdf;

        const handleSearch = (e) => {
            e.preventDefault();
            const term = searchTerm.toLowerCase().trim();
            if (!term) {
                setSelectedRecipient(null);
                setRecipientHistory([]);
                return;
            }
            
            const foundRecipient = recipients.find(r => 
                r.name.toLowerCase().includes(term) || 
                (r.regNumber && r.regNumber.toLowerCase().includes(term))
            );
            
            setSelectedRecipient(foundRecipient || null);

            if (foundRecipient) {
                const history = issueLog.filter(log => log.recipientId === foundRecipient.id)
                                        .sort((a, b) => new Date(b.dateIssued) - new Date(a.dateIssued));
                setRecipientHistory(history);
            } else {
                setRecipientHistory([]);
            }
        };

        const pendingItemsCount = recipientHistory.filter(log => !log.returned).length;
        
        const generateClearanceReport = () => {
            if (!selectedRecipient) return;
            
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            if (settings.logo) { try { doc.addImage(settings.logo, 'PNG', 15, 10, 20, 20); } catch(e) { console.error("Error adding logo", e); } }
            doc.setFontSize(16); doc.text(settings.institutionName, pageWidth / 2, 20, { align: 'center' });
            doc.setFontSize(14); doc.text("Clearance Report", pageWidth / 2, 30, { align: 'center' });
            
            doc.setFontSize(12); doc.text(`Name: ${selectedRecipient.name}`, 15, 45);
            doc.text(`Type: ${selectedRecipient.type}`, 15, 52);
            if(selectedRecipient.regNumber) doc.text(`Reg/ID No: ${selectedRecipient.regNumber}`, 15, 59);

            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth - 15, 45, { align: 'right' });

            const head = [['Item Name / Serial', 'Date Issued', 'Expected Return', 'Status', 'Date Returned']];
            const body = recipientHistory.map(log => [
                log.serialNumber ? `${log.itemName}\n(${log.serialNumber})` : log.itemName,
                new Date(log.dateIssued).toLocaleDateString(),
                log.returnDate ? new Date(log.returnDate).toLocaleDateString() : 'N/A',
                log.returned ? 'Returned' : 'Pending Return',
                log.dateReturned ? new Date(log.dateReturned).toLocaleDateString() : '-'
            ]);
            
            doc.autoTable({ head, body, startY: 65 });
            
            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Summary: ${pendingItemsCount} item(s) pending return.`, 15, finalY + 10);
            
            doc.save(`Clearance_${selectedRecipient.name.replace(/ /g, '_')}.pdf`);
        };

        return (
            <div className="space-y-6">
                <h1 className="text-3xl font-bold text-text-primary">Clearance Check</h1>

                <div className="bg-surface rounded-lg shadow p-4">
                    <form onSubmit={handleSearch} className="flex items-center space-x-4">
                        <input 
                            type="text" 
                            placeholder="Search by Name or Reg/ID Number..." 
                            className="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                        />
                        <button type="submit" className="bg-primary text-white font-bold py-2 px-4 rounded-lg"><i className="fas fa-search mr-2"></i>Search</button>
                    </form>
                </div>

                {selectedRecipient ? (
                    <div className="bg-surface rounded-lg shadow p-6 animate-fade-in-down">
                        <div className="flex justify-between items-start">
                           <div>
                                <h2 className="text-2xl font-bold text-text-primary">{selectedRecipient.name}</h2>
                                <p className="text-text-secondary">{selectedRecipient.type} {selectedRecipient.regNumber && `(${selectedRecipient.regNumber})`}</p>
                           </div>
                           <button onClick={generateClearanceReport} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow">
                                <i className="fas fa-print mr-2"></i> Print Report
                            </button>
                        </div>
                        <div className={`mt-4 p-4 rounded-lg ${pendingItemsCount > 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                           <p className="font-bold">{pendingItemsCount} item(s) pending return.</p>
                        </div>

                        <div className="mt-6">
                            <h3 className="text-lg font-semibold mb-2">Issue History</h3>
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="w-full text-sm text-left text-gray-500">
                                    <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3">Item / Serial</th>
                                            <th className="px-6 py-3">Date Issued</th>
                                            <th className="px-6 py-3">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {recipientHistory.map(log => (
                                            <tr key={log.id} className="bg-white border-b hover:bg-gray-50">
                                                <td className="px-6 py-4 font-medium text-gray-900">
                                                    {log.itemName}
                                                    {log.serialNumber && <span className="block text-xs text-gray-500">{log.serialNumber}</span>}
                                                </td>
                                                <td className="px-6 py-4">{new Date(log.dateIssued).toLocaleDateString()}</td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${log.returned ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                                        {log.returned ? 'Returned' : 'Issued'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {recipientHistory.length === 0 && <p className="text-center p-4">No issue history found for this recipient.</p>}
                            </div>
                        </div>
                    </div>
                ) : (
                    <div className="bg-surface rounded-lg shadow p-6 text-center text-text-secondary">
                        <i className="fas fa-search text-4xl mb-4"></i>
                        <p>Search for a recipient to view their issue history and clearance status.</p>
                    </div>
                )}
            </div>
        );
    };

    const RecipientsPage = () => {
        const { recipients, addRecipient, updateRecipient, deleteRecipient } = useAppContext();
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [currentItem, setCurrentItem] = useState(null);

        const openModal = (item = null) => {
            setCurrentItem(item);
            setIsModalOpen(true);
        };

        const closeModal = () => {
            setIsModalOpen(false);
            setCurrentItem(null);
        };

        const handleSave = (data) => {
            if (currentItem) {
                updateRecipient({ ...currentItem, ...data });
            } else {
                addRecipient(data);
            }
            closeModal();
        };
        
        const RecipientFormModal = ({ isOpen, onClose, onSave, item }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                setFormData(item || { name: '', type: 'Trainee', regNumber: '' });
            }, [item]);

            const handleChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={item ? "Edit Recipient" : "Add Recipient"}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label>Name</label>
                            <input type="text" name="name" value={formData.name || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" required />
                        </div>
                        <div>
                            <label>Type</label>
                            <select name="type" value={formData.type || 'Trainee'} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                                <option>Trainee</option><option>Trainer</option><option>Staff</option><option>Department</option><option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Registration/ID Number (Optional)</label>
                            <input type="text" name="regNumber" value={formData.regNumber || ''} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" />
                        </div>
                        <div className="flex justify-end pt-4">
                            <button type="button" onClick={onClose} className="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-300">Cancel</button>
                            <button type="submit" className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Save</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold text-text-primary">Recipients</h1>
                    <button onClick={() => openModal()} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg shadow">
                       <i className="fas fa-plus mr-2"></i> Add New Recipient
                    </button>
                </div>
                <div className="bg-surface rounded-lg shadow overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-500">
                        <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th className="px-6 py-3">Name</th>
                                <th className="px-6 py-3">Type</th>
                                <th className="px-6 py-3">Reg/ID No.</th>
                                <th className="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {recipients.map(r => (
                                <tr key={r.id} className="bg-white border-b hover:bg-gray-50">
                                    <td className="px-6 py-4">{r.name}</td>
                                    <td className="px-6 py-4">{r.type}</td>
                                    <td className="px-6 py-4">{r.regNumber}</td>
                                    <td className="px-6 py-4 space-x-4">
                                        <button onClick={() => openModal(r)} className="font-medium text-primary hover:underline">Edit</button>
                                        <button onClick={() => deleteRecipient(r.id)} className="font-medium text-red-600 hover:underline">Delete</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <RecipientFormModal isOpen={isModalOpen} onClose={closeModal} onSave={handleSave} item={currentItem} />
            </div>
        );
    };

    const Reports = () => {
        const { inventory, assets, disposalLog, settings, user, updateDisposalStatus, addDisposalRequest } = useAppContext();
        const { jsPDF } = window.jspdf;
        const [isDisposalModalOpen, setIsDisposalModalOpen] = useState(false);
        const [itemToDispose, setItemToDispose] = useState(null);

        const openDisposalModal = (asset) => {
          setItemToDispose(asset);
          setIsDisposalModalOpen(true);
        };

        const handleDisposalSave = (disposalData) => {
            addDisposalRequest(disposalData);
            setIsDisposalModalOpen(false);
            setItemToDispose(null);
        };

        const obsoleteForDisposal = useMemo(() => assets.filter(a => a.condition === 'Obsolete' && a.status === 'In Stock'), [assets]);


        const generatePdf = (title, head, body) => {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            if (settings.logo) { try { doc.addImage(settings.logo, 'PNG', 15, 10, 30, 30); } catch(e) { console.error("Error adding logo to PDF", e); } }
            doc.setFontSize(20); doc.setFont('helvetica', 'bold'); doc.text(settings.institutionName || "Inventory Report", pageWidth / 2, 25, { align: 'center' });
            doc.setFontSize(14); doc.setFont('helvetica', 'normal'); doc.text(title, pageWidth / 2, 35, { align: 'center' });
            doc.setFontSize(10); doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth - 15, 20, { align: 'right' });

            doc.autoTable({ head: [head], body: body, startY: 50, theme: 'grid', headStyles: { fillColor: [79, 70, 229] } });
            
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.text('Page ' + String(i) + ' of ' + String(pageCount), pageWidth - 15, doc.internal.pageSize.getHeight() - 10, { align: 'right' }); }

            doc.save(`${title.replace(/ /g, '_')}.pdf`);
        };

        const generateFullStockReport = () => {
            const head = ['Name', 'Category', 'Quantity', 'Unit', 'Type', 'Serial No.', 'Condition'];
            const body = [];
            inventory.forEach(item => {
                if (item.type === 'Consumable') {
                    body.push([item.name, item.category, item.quantity, item.unit, item.type, 'N/A', 'N/A']);
                } else {
                    const itemAssets = assets.filter(a => a.inventoryId === item.id);
                    if (itemAssets.length > 0) {
                        itemAssets.forEach(asset => {
                            body.push([item.name, item.category, 1, item.unit, item.type, asset.serialNumber, asset.condition]);
                        });
                    } else {
                        body.push([item.name, item.category, 0, item.unit, item.type, 'N/A', 'N/A']);
                    }
                }
            });
            generatePdf('Full Stock Report (with Serials)', head, body);
        };
        
        const generateAssetReport = () => {
            const head = ['Name', 'Serial No.', 'Category', 'Department', 'Condition', 'Status'];
            const body = [];
            assets.forEach(asset => {
                const itemInfo = inventory.find(i => i.id === asset.inventoryId);
                if(itemInfo) body.push([itemInfo.name, asset.serialNumber, itemInfo.category, itemInfo.department, asset.condition, asset.status]);
            });
            generatePdf('Serialized Asset Report', head, body);
        };
        
        const generateDisposalForm = (log) => {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            if (settings.logo) { doc.addImage(settings.logo, 'PNG', 15, 10, 20, 20); }
            doc.setFontSize(16); doc.text(settings.institutionName, pageWidth / 2, 20, { align: 'center' });
            doc.setFontSize(12); doc.text("ASSET DISPOSAL FORM", pageWidth / 2, 30, { align: 'center' });
            doc.setLineWidth(0.5); doc.line(15, 35, pageWidth - 15, 35);
            doc.autoTable({ startY: 40, theme: 'plain', body: [['Item to be Disposed:', log.itemName], ['Category:', log.itemCategory], ['Date of Request:', new Date().toLocaleDateString()], ['Recommended Method:', log.method], ['Status:', log.status], ['Reason for Disposal:', 'Marked as Obsolete']] });
            const finalY = doc.autoTable.previous.finalY;
            doc.text("Authorization:", 15, finalY + 15);
            doc.text("Procurement Officer: ....................................", 15, finalY + 30); doc.text("Date: ......................", 140, finalY + 30);
            doc.text("Head of Institution: ....................................", 15, finalY + 45); doc.text("Date: ......................", 140, finalY + 45);
            doc.save(`Disposal_Form_${log.itemName.replace(/ /g, '_')}.pdf`);
        };
        
        const statusColors = { Pending: 'bg-yellow-100 text-yellow-800', Approved: 'bg-green-100 text-green-800', Rejected: 'bg-red-100 text-red-800', Disposed: 'bg-gray-100 text-gray-800' };

        return (
            <div className="space-y-6">
                <h1 className="text-3xl font-bold text-text-primary">Reports & Disposal</h1>
                
                <div className="bg-surface rounded-lg shadow p-6">
                    <h2 className="text-xl font-semibold mb-4">Generate Reports</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <ReportCard title="Full Stock Report" icon="fa-boxes-stacked" onClick={generateFullStockReport} />
                        <ReportCard title="Asset Report" icon="fa-computer" onClick={generateAssetReport} />
                    </div>
                </div>

                 <div className="bg-surface rounded-lg shadow">
                    <h2 className="text-xl font-semibold p-4 border-b">Obsolete Assets for Disposal</h2>
                    <div className="overflow-x-auto">
                         <table className="w-full text-sm text-left text-gray-500">
                             <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3">Item Name</th>
                                    <th className="px-6 py-3">Serial No.</th>
                                    <th className="px-6 py-3">Category</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {obsoleteForDisposal.map(asset => {
                                    const itemInfo = inventory.find(i => i.id === asset.inventoryId);
                                    return (
                                     <tr key={asset.id} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4">{itemInfo?.name}</td>
                                        <td className="px-6 py-4">{asset.serialNumber}</td>
                                        <td className="px-6 py-4">{itemInfo?.category}</td>
                                        <td className="px-6 py-4">
                                            <button onClick={() => openDisposalModal(asset)} className="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">Request Disposal</button>
                                        </td>
                                    </tr>
                                )})}
                            </tbody>
                        </table>
                        {obsoleteForDisposal.length === 0 && <p className="text-center p-4">No obsolete assets awaiting disposal.</p>}
                    </div>
                </div>


                 <div className="bg-surface rounded-lg shadow mt-8">
                    <h2 className="text-xl font-semibold p-4 border-b">Disposal Requests Log</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-gray-500">
                             <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3">Item Name (Serial)</th>
                                    <th className="px-6 py-3">Status</th>
                                    <th className="px-6 py-3">Method</th>
                                    <th className="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {disposalLog.map(log => (
                                     <tr key={log.id} className="bg-white border-b hover:bg-gray-50">
                                        <td className="px-6 py-4">{log.itemName}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 text-xs font-medium rounded-full ${statusColors[log.status] || ''}`}>{log.status}</span></td>
                                        <td className="px-6 py-4">{log.method}</td>
                                        <td className="px-6 py-4 space-x-2 whitespace-nowrap">
                                            <button onClick={() => generateDisposalForm(log)} className="font-medium text-primary hover:underline"><i className="fas fa-file-pdf mr-1"></i> Form</button>
                                            {user.role === 'admin' && (
                                                <>
                                                    {log.status === 'Pending' && (<>
                                                        <button onClick={() => updateDisposalStatus(log.id, 'Approved')} className="font-medium text-green-600 hover:underline">Approve</button>
                                                        <button onClick={() => updateDisposalStatus(log.id, 'Rejected')} className="font-medium text-red-600 hover:underline">Reject</button>
                                                    </>)}
                                                    {log.status === 'Approved' && (
                                                        <button onClick={() => updateDisposalStatus(log.id, 'Disposed')} className="font-medium text-gray-600 hover:underline">Mark Disposed</button>
                                                    )}
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {disposalLog.length === 0 && <p className="text-center p-4">No disposal requests found.</p>}
                    </div>
                </div>
                {itemToDispose && <DisposalFormModal isOpen={isDisposalModalOpen} onClose={() => { setIsDisposalModalOpen(false); setItemToDispose(null); }} onSave={handleDisposalSave} asset={itemToDispose} />}
            </div>
        );
    };
    
    const ReportCard = ({ title, icon, onClick }) => (
        <button onClick={onClick} className="bg-surface rounded-lg shadow p-5 flex flex-col items-center justify-center space-y-3 transition-all transform hover:scale-105 hover:shadow-lg hover:bg-indigo-50">
            <div className="text-4xl text-primary"><i className={`fas ${icon}`}></i></div>
            <p className="text-md font-semibold text-text-primary text-center">{title}</p>
        </button>
    );

    const Settings = () => {
        const { settings, updateSettings, showToast, importData } = useAppContext();
        const [institutionName, setInstitutionName] = useState(settings.institutionName);
        const [logo, setLogo] = useState(settings.logo);

        const handleSave = () => {
            updateSettings({ institutionName, logo });
        };
        
        const handleLogoUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => setLogo(event.target.result);
                reader.readAsDataURL(file);
            }
        };

        const exportData = () => {
            const data = {
                inventory: JSON.parse(localStorage.getItem('inventory')),
                assets: JSON.parse(localStorage.getItem('assets')),
                recipients: JSON.parse(localStorage.getItem('recipients')),
                issueLog: JSON.parse(localStorage.getItem('issueLog')),
                disposalLog: JSON.parse(localStorage.getItem('disposalLog')),
                settings: JSON.parse(localStorage.getItem('settings')),
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `tvet-procstore-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        };

        const handleDataImport = (e) => {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = (event) => importData(event.target.result);
                reader.readAsText(file);
            }
        };

        return (
            <div className="space-y-6 max-w-2xl mx-auto">
                <h1 className="text-3xl font-bold text-text-primary">Settings</h1>

                <div className="bg-surface rounded-lg shadow p-6 space-y-4">
                     <div>
                        <label className="block text-sm font-medium text-gray-700">Institution Name</label>
                        <input type="text" value={institutionName} onChange={(e) => setInstitutionName(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"/>
                    </div>
                    <div>
                         <label className="block text-sm font-medium text-gray-700">Institution Logo</label>
                         <div className="mt-1 flex items-center space-x-4">
                            <img src={logo} alt="Logo Preview" className="h-16 w-16 object-contain bg-gray-100 rounded-md"/>
                             <input type="file" accept="image/*" onChange={handleLogoUpload} className="text-sm" />
                         </div>
                    </div>
                    <div className="flex justify-end pt-2">
                        <button onClick={handleSave} className="bg-gradient-to-r from-primary to-primary-end hover:from-primary-end hover:to-primary text-white font-bold py-2 px-4 rounded-lg">Save Settings</button>
                    </div>
                </div>

                <div className="bg-surface rounded-lg shadow p-6 space-y-4">
                    <h2 className="text-xl font-semibold">Data Management</h2>
                    <div className="flex space-x-4">
                        <button onClick={exportData} className="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg"><i className="fas fa-download mr-2"></i> Export Data (Backup)</button>
                         <label className="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer text-center">
                            <i className="fas fa-upload mr-2"></i> Import Data (Restore)
                            <input type="file" accept=".json" onChange={handleDataImport} className="hidden" />
                         </label>
                    </div>
                </div>
            </div>
        );
    };

      
      const Sidebar = ({ activePage, setActivePage, onLogout, user }) => {
        const { settings } = useAppContext();
        const isAdmin = user?.role === 'admin';
        
        const NavLink = ({ page, icon, children }) => (
          <li className={`cursor-pointer rounded-md transition-colors ${activePage === page ? 'bg-indigo-700' : 'hover:bg-indigo-500'}`}>
            <a onClick={() => setActivePage(page)} className="flex items-center p-3"><i className={`fas ${icon} w-6 text-center`}></i><span className="ml-3">{children}</span></a>
          </li>
        );

        return (
          <aside className="w-64 bg-gradient-to-b from-primary to-primary-end text-white flex flex-col fixed h-full shadow-lg">
            <div className="p-4 flex items-center space-x-3 border-b border-indigo-500">
                <img src={settings.logo} alt="Logo" className="w-12 h-12 rounded-full bg-white p-1"/>
                <h1 className="text-xl font-bold">{settings.institutionName}</h1>
            </div>
            <nav className="flex-1 p-4">
              <ul className="space-y-2">
                <NavLink page="dashboard" icon="fa-chart-pie">Dashboard</NavLink>
                <NavLink page="inventory" icon="fa-box">Inventory</NavLink>
                <NavLink page="issueLog" icon="fa-clipboard-list">Issue Log</NavLink>
                <NavLink page="recipients" icon="fa-users">Recipients</NavLink>
                <NavLink page="clearance" icon="fa-user-check">Clearance</NavLink>
                <NavLink page="reports" icon="fa-file-pdf">Reports & Disposal</NavLink>
                {isAdmin && <NavLink page="settings" icon="fa-cog">Settings</NavLink>}
              </ul>
            </nav>
            <div className="p-4 border-t border-indigo-500">
               <div className="flex items-center space-x-3 mb-4">
                 <div className="w-10 h-10 rounded-full bg-indigo-200 text-primary flex items-center justify-center font-bold text-lg">{user.username.charAt(0).toUpperCase()}</div>
                 <div><p className="font-semibold">{user.username}</p><p className="text-xs text-indigo-200 capitalize">{user.role}</p></div>
               </div>
               <button onClick={onLogout} className="w-full text-left flex items-center p-3 rounded-md hover:bg-indigo-500 transition-colors">
                  <i className="fas fa-sign-out-alt w-6 text-center"></i><span className="ml-3">Logout</span>
               </button>
            </div>
          </aside>
        );
      };

      const App = () => {
        const { user, handleLogin, handleLogout, isOnline } = useAppContext();
        const [activePage, setActivePage] = useState('dashboard');
        const [installPrompt, setInstallPrompt] = useState(null);

        useEffect(() => {
            const beforeInstallHandler = (e) => {
                e.preventDefault();
                setInstallPrompt(e);
            };
            const appInstalledHandler = () => {
                setInstallPrompt(null);
            };

            window.addEventListener('beforeinstallprompt', beforeInstallHandler);
            window.addEventListener('appinstalled', appInstalledHandler);

            return () => {
                window.removeEventListener('beforeinstallprompt', beforeInstallHandler);
                window.removeEventListener('appinstalled', appInstalledHandler);
            };
        }, []);

        const handleInstallClick = () => {
            if (!installPrompt) return;
            installPrompt.prompt();
            installPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                setInstallPrompt(null);
            });
        };

        if (!user) {
          return <LoginPage onLogin={handleLogin} />;
        }
        
        const renderPage = () => {
          switch (activePage) {
            case 'dashboard': return <Dashboard />;
            case 'inventory': return <Inventory />;
            case 'issueLog': return <IssueLogPage />;
            case 'recipients': return <RecipientsPage />;
            case 'clearance': return <ClearancePage />;
            case 'reports': return <Reports />;
            case 'settings': return <Settings />;
            default: return <Dashboard />;
          }
        };

        return (
          <div className="flex h-screen bg-background">
            <Sidebar activePage={activePage} setActivePage={setActivePage} onLogout={handleLogout} user={user} />
            <div className="flex-1 flex flex-col ml-64">
                <header className="bg-surface shadow-sm p-4 flex justify-end items-center space-x-4">
                    {installPrompt && (
                        <button
                            onClick={handleInstallClick}
                            className="bg-primary hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg shadow transition-colors text-sm animate-pulse"
                            title="Install App"
                        >
                            <i className="fas fa-download mr-2"></i>Install App
                        </button>
                    )}
                    <div className={`flex items-center space-x-2 px-3 py-1 rounded-full text-sm ${isOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        <span className={`h-2 w-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`}></span>
                        <span>{isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                </header>
                <main className="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    <div className="max-w-7xl mx-auto">
                        {renderPage()}
                    </div>
                     <footer className="text-center p-4 text-xs text-text-secondary mt-auto">
                      © {new Date().getFullYear()} TVET PROCSTORE. All rights reserved. Made with <i className="fas fa-heart text-red-500"></i> by Mr Felix.
                    </footer>
                </main>
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <AppProvider>
            <App />
          </AppProvider>
        </React.StrictMode>
      );
    </script>
  </body>
</html>